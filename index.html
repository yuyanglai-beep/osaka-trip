<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>Osaka Trip ğŸ± - v10-milktea-shared</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2ï¼ˆå…±åŒè¨˜å¸³ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- PWA theme colorï¼ˆå¿…åŠ ï¼‰ -->
  <meta name="theme-color" content="#c8a889">

  <!-- Service Worker è¨»å†Šï¼ˆè®“Appå¯å®‰è£/é›¢ç·šï¼‰ -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>


  <style>
:root{
  --bg:#efe8df;
  --card:#ffffff;
  --ink:#3f352b;
  --muted:#7a6d60;
  --line:#e6ddd2;
  --accent:#c8a889;        /* main milk-tea */
  --accent-soft:#f3ece4;   /* soft milk-tea */
  --accent-dark:#a88463;   /* deeper header */
  --important:#c3d1be;     /* genmaicha green for reminders edge */
  --important-soft:#f1f4f0;
  --important-text:#3a4e3e;
}
body::before{
  content:"";
  position:fixed; inset:0;
  background:
    radial-gradient(800px 400px at 0% -10%, rgba(200,168,137,0.14), transparent 60%),
    radial-gradient(700px 360px at 100% 0%, rgba(168,132,99,0.10), transparent 60%);
  z-index:-1;
}
.topbar{
  position:sticky; top:0; z-index:35;
  background:linear-gradient(180deg, rgba(200,168,137,0.98), rgba(168,132,99,0.98));
  color:white;
  border-bottom:1px solid rgba(255,255,255,0.25);
}
.topbar-inner{
  max-width:440px; margin:0 auto; padding:12px 12px 10px;
}
.title{ font-weight:900; font-size:20px; letter-spacing:.4px;}
.subtitle{ color:rgba(255,255,255,0.85); font-size:12px; margin-top:2px;}
.chip{
  background:rgba(255,255,255,0.14);
  border:1px solid rgba(255,255,255,0.3);
  border-radius:999px;
  padding:6px 10px; font-size:12px; font-weight:900; color:white;
  backdrop-filter: blur(4px);
}
.chip.hotel{ background:rgba(255,255,255,0.18); }
.btn.map{ color:#7b5b3f; border-color:#e9d7c3; background:#f7efe6; }
.btn.nav{ color:#0b7a41; border-color:#bbf7d0; background:#ecfdf5; }
.tabbtn.active{ background:var(--accent-soft); color:#7b5b3f; }
.time{ color:#7b5b3f; }
.pill{ color:#7b5b3f; }

body { background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; -webkit-tap-highlight-color:transparent; }
.phone { max-width:440px; margin:0 auto; min-height:100vh; padding:0 12px 96px; }
.seg { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
.tabbar { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); width:92%; max-width:420px; background:var(--card); border:1px solid var(--line); border-radius:16px; display:flex; padding:6px; gap:6px; box-shadow:0 10px 25px rgba(0,0,0,0.08); z-index:40; }
.tabbtn { flex:1; text-align:center; padding:8px 0; font-size:12px; font-weight:900; color:var(--muted); border-radius:12px; }
.day { display:none; padding-top:10px; }
.day.active { display:block; }
.dayhead { margin:6px 2px 10px; display:flex; flex-direction:column; gap:6px; }
.daytitle { font-weight:900; font-size:16px; display:flex; justify-content:space-between; align-items:flex-end; }
.weather { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:6px 8px; font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px; min-width:140px; justify-content:flex-end; }
.today-imp { background:var(--important-soft); border:1px solid rgba(195,209,190,0.8); border-left:4px solid var(--important); border-radius:12px; padding:8px 10px; font-size:13px; font-weight:900; color:var(--important-text); display:none; }
.today-imp.show{ display:block; }
.card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; margin-bottom:9px; box-shadow:0 1px 0 rgba(0,0,0,0.03); position:relative; }
.card.important{ border-left:4px solid var(--important); background:linear-gradient(180deg, #fff, var(--important-soft)); }
.important-badge{ font-size:11px; font-weight:900; color:var(--important-text); background:var(--important-soft); border:1px solid rgba(195,209,190,0.9); border-radius:8px; padding:2px 6px; }
.time { font-weight:900; font-size:12px; letter-spacing:.3px; }
.row { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; margin-top:4px; }
.h3 { font-weight:900; font-size:15px; line-height:1.35; }
.note { font-size:13px; color:var(--ink); white-space:pre-line; margin-top:6px; line-height:1.6; }
.btn { border:1px solid var(--line); background:rgba(255,255,255,0.95); border-radius:10px; padding:6px 8px; font-size:12px; font-weight:900; display:inline-flex; align-items:center; gap:6px; }
.btn.search { color:#7c3aed; border-color:#ddd6fe; background:#f5f3ff; }
.sub { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
.subitem { background:rgba(255,255,255,0.9); border:1px dashed var(--line); border-radius:10px; padding:8px; display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:13px; font-weight:800; }
.pills { padding:8px 2px 2px; display:flex; gap:8px; overflow-x:auto; }
.pill { background:var(--card); border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; font-weight:900; white-space:nowrap; }
.tools { display:none; padding-top:8px; }
.tools.active { display:block; }
.tools-card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; margin-bottom:10px; }
.tools-title { font-weight:900; font-size:14px; margin-bottom:6px; }
input, select { width:100%; border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:13px; background:white; }
.budget-row { display:grid; grid-template-columns: 1fr 92px 90px; gap:6px; margin-top:8px; }
.budget-total { font-weight:900; color:#7b5b3f; margin-top:8px; font-size:14px; }
.muted { color:var(--muted); font-size:12px; }
/* modals */
.modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.35); display:none; align-items:center; justify-content:center; padding:14px; }
.modal-backdrop.show { display:flex; }
#hotelModal { z-index:100; }
#mapModal { z-index:120; }
#tripModal { z-index:120; }
.modal-sheet { width:100%; max-width:420px; background:var(--card); border-radius:14px; overflow:hidden; border:1px solid var(--line); box-shadow:0 18px 50px rgba(0,0,0,0.28); }
.modal-sheet.full { height:92vh; }
.modal-head { padding:10px 12px; background:var(--accent-dark); color:white; font-weight:900; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
.modal-close { background:white; color:var(--accent-dark); width:26px; height:26px; border-radius:999px; font-weight:900; display:flex; align-items:center; justify-content:center; }
.modal-map { height:calc(92vh - 44px); background:#0b1220; }
.modal-body { padding:12px; }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="title">Osaka Trip ğŸ±</div>
      <div class="subtitle">æ—¥æœ¬å¤§é˜ª ï½œå››å¤©ä¸‰å¤œğŸ‡¯ğŸ‡µ 12/5â€“12/8</div>
      <div class="seg">
        <button class="chip" onclick="openTripModal('GK050','https://tw.trip.com/actualtime/detail?flightNo=GK050&departCity=TPE&arriveCity=KIX&date=2025-12-05&locale=zh-TW&curr=TWD')">âœˆï¸ GK050</button>
        <button class="chip" onclick="openTripModal('BR131','https://tw.trip.com/actualtime/detail?flightNo=BR131&departCity=KIX&arriveCity=TPE&date=2025-12-08&locale=zh-TW&curr=TWD')">âœˆï¸ BR131</button>
        <button class="chip hotel" onclick="openHotelModal()">ğŸ¨ Dormy inn PREMIUM Nanba ANNEX</button>
      </div>
    </div>
  </div>

  <div class="phone">
    <main id="main"></main>
    <section id="tools" class="tools"></section>

    <nav class="tabbar">
      <button id="tab-itin" class="tabbtn active" onclick="showTab('itin')">è¡Œç¨‹</button>
      <button id="tab-tools" class="tabbtn" onclick="showTab('tools')">è¨˜å¸³</button>
    </nav>
  </div>

  <!-- Map Modal -->
  <div id="mapModal" class="modal-backdrop">
    <div class="modal-sheet full">
      <div class="modal-head">
        <div id="mapModalTitle">åœ°åœ–</div>
        <button class="modal-close" onclick="closeMapModal()">âœ•</button>
      </div>
      <div id="mapModalMap" class="modal-map"></div>
    </div>
  </div>

  <!-- Trip Modal -->
  <div id="tripModal" class="modal-backdrop">
    <div class="modal-sheet full">
      <div class="modal-head">
        <div id="tripModalTitle">èˆªç­è³‡è¨Š</div>
        <button class="modal-close" onclick="closeTripModal()">âœ•</button>
      </div>
      <div id="tripModalBody" class="modal-map"></div>
    </div>
  </div>

  <!-- Hotel Modal -->
  <div id="hotelModal" class="modal-backdrop">
    <div class="modal-sheet">
      <div class="modal-head">
        <div>ä½å®¿è³‡è¨Š</div>
        <button class="modal-close" onclick="closeHotelModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="font-extrabold text-slate-900">Dormy inn PREMIUM Nanba ANNEX</div>
        <div class="mt-2 flex gap-2">
          <button class="btn map" onclick="openMapModal('Dormy inn PREMIUM Nanba ANNEX','https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Dormy%20inn%20PREMIUM%20Nanba%20ANNEX')">åœ°åœ–</button>
          <a class="btn nav" href="https://www.google.com/maps/dir/?api=1&destination=Dormy%20inn%20PREMIUM%20Nanba%20ANNEX&travelmode=driving" target="_blank" rel="noopener">å°èˆª</a>
        </div>

        <div class="mt-4 font-extrabold text-sm">æˆ¿é–“è™Ÿç¢¼</div>
        <input id="roomNumberInput" placeholder="ä¾‹å¦‚ï¼š1203" class="mt-2">
        <div class="muted mt-1">æœƒè‡ªå‹•å„²å­˜åœ¨æ‰‹æ©Ÿï¼Œä¸æ€•å¿˜è¨˜ã€‚</div>
      </div>
    </div>
  </div>

<script>
/* ---------------- PWAï¼šè¨»å†Š Service Worker ---------------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

/* ---------------- Supabase è¨­å®šï¼ˆå…±åŒè¨˜å¸³ç”¨ï¼‰ ---------------- */
/*
  è«‹å…ˆåœ¨ Supabase å»ºç«‹ä¸€å€‹è³‡æ–™è¡¨ budgetsï¼Œæ¬„ä½ï¼š
  - id         uuid (Primary key, default gen_random_uuid())
  - trip_id    text
  - note       text
  - amount     integer
  - payer      text
  - created_at timestamp (default now())
*/

const SUPABASE_URL = "https://fmrk...se.co";     // â† æ›æˆä½ è‡ªå·±çš„
const SUPABASE_ANON_KEY =  "eyJhb...GevP8";            // â† æ›æˆä½ è‡ªå·±çš„
const supabaseClient = window.supabase ?
  window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) :
  null;

// é€™å€‹è¡Œç¨‹çš„ IDï¼ˆçµ¦å¤šå€‹è¡Œç¨‹å…±ç”¨æ™‚å€åˆ†ç”¨ï¼‰
const TRIP_ID = "osaka-v10-milktea";

/* ---------------- åŸæœ¬ DATAï¼ˆè¡Œç¨‹è³‡æ–™ï¼‰ ---------------- */
const DATA = {"appTitle": "Osaka Trip ğŸ±", "dateRange": "æ—¥æœ¬å¤§é˜ª ï½œå››å¤©ä¸‰å¤œğŸ‡¯ğŸ‡µ 12/5â€“12/8", "flights": {"outbound": {"label": "GK050", "trip_url": "https://tw.trip.com/actualtime/detail?flightNo=GK050&departCity=TPE&arriveCity=KIX&date=2025-12-05&locale=zh-TW&curr=TWD", "time": "TPE 02:30 â†’ KIX 06:00"}, "inbound": {"label": "BR131", "trip_url": "https://tw.trip.com/actualtime/detail?flightNo=BR131&departCity=KIX&arriveCity=TPE&date=2025-12-08&locale=zh-TW&curr=TWD", "time": "KIX 12:55 â†’ TPE 15:05"}}, "hotel": "Dormy inn PREMIUM Nanba ANNEX", "hotelMap": "https://www.google.com/maps/place/Dormy+inn+PREMIUM+Nanba+ANNEX/data=!4m2!3m1!1s0x0:0xa2f84770b4e09b49?sa=X&ved=1t:2428&ictx=111", "days": [{"city_hint": "Osaka", "title": "12/5ï¼ˆäº”ï¼‰ Day1 æµ·éŠé¤¨-å¿ƒé½‹æ©‹", "events": [{"start": "07:30", "end": "09:00", "icon": "ğŸš„", "title": "å—æµ·ç‰¹æ€¥-ä¾¿åˆ©å•†åº—", "note": "å¯ä»¥å…ˆä¸Šç¶²è²·ç¥¨/ç¾å ´ç›´æ¥è²·ç¥¨\nç­æ¬¡å¾ˆå¤š"}, {"start": "09:30", "end": "10:00", "icon": "ğŸ§³", "title": "å¯„è¡Œæ", "note": "é£¯åº—å¯„ç‰©"}, {"start": "11:00", "end": "15:00", "icon": "ğŸ‹", "title": "æµ·éŠé¤¨ Osaka Aquarium Kaiyukan", "note": "çœ‹å®Œå¯ä»¥é€›å¤§é˜ªæ¸¯\nğŸ«é–€ç¥¨ï¼šæµ®å‹•åƒ¹æ ¼ å¯å…ˆè¨‚", "map_query": "æµ·éŠé¤¨ Osaka Aquarium Kaiyukan", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E6%B5%B7%E9%81%8A%E9%A4%A8%20Osaka%20Aquarium%20Kaiyukan", "map_external": "https://www.google.com/maps/search/?api=1&query=%E6%B5%B7%E9%81%8A%E9%A4%A8%20Osaka%20Aquarium%20Kaiyukan", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E6%B5%B7%E9%81%8A%E9%A4%A8%20Osaka%20Aquarium%20Kaiyukan&travelmode=driving"}, {"start": "15:30", "end": "17:00", "icon": "ğŸ›ï¸", "title": "ä¼‘æ¯ï¼é€›é€›æ™‚é–“", "note": "ç´¯ç´¯æ‰€ä»¥é›£æ³¢æ‹¿è¡Œæ&check in\næœ‰æ™‚é–“å¯å»é›£æ³¢å…«é˜ªç¥ç¤¾"}, {"start": "17:30", "end": "19:00", "icon": "ğŸ¥£", "title": "æ™šé¤", "note": "æ¿å‰ç‡’è‚‰ä¸€æ–—", "map_query": "æ¿å‰ç‡’è‚‰ä¸€æ–— æ±å¿ƒé½‹æ©‹åº—", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E6%9D%BF%E5%89%8D%E7%87%92%E8%82%89%E4%B8%80%E6%96%97%20%E6%9D%B1%E5%BF%83%E9%BD%8B%E6%A9%8B%E5%BA%97", "map_external": "https://www.google.com/maps/search/?api=1&query=%E6%9D%BF%E5%89%8D%E7%87%92%E8%82%89%E4%B8%80%E6%96%97%20%E6%9D%B1%E5%BF%83%E9%BD%8B%E6%A9%8B%E5%BA%97", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E6%9D%BF%E5%89%8D%E7%87%92%E8%82%89%E4%B8%80%E6%96%97%20%E6%9D%B1%E5%BF%83%E9%BD%8B%E6%A9%8B%E5%BA%97&travelmode=driving"}, {"start": "19:00", "icon": "ğŸ›’", "title": "é“é “å € & å¿ƒé½‹æ©‹é€›è¡—", "note": "âš ï¸ ç™¾è²¨å…¬å¸ 20:00 é—œ è¦é€›å…ˆé€›ç™¾è²¨", "map_query": "é“é “å € å¿ƒé½‹æ©‹", "subitems": [{"text": "ğŸ™ KUKURU", "map_query": "KUKURU é“é “å €", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=KUKURU%20%E9%81%93%E9%A0%93%E5%A0%80", "map_external": "https://www.google.com/maps/search/?api=1&query=KUKURU%20%E9%81%93%E9%A0%93%E5%A0%80", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=KUKURU%20%E9%81%93%E9%A0%93%E5%A0%80&travelmode=driving"}, {"text": "ğŸ‹ğŸ» å¿ƒé½‹æ©‹è·‘è·‘äºº", "map_query": "å¿ƒé½‹æ©‹è·‘è·‘äºº", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E5%BF%83%E9%BD%8B%E6%A9%8B%E8%B7%91%E8%B7%91%E4%BA%BA", "map_external": "https://www.google.com/maps/search/?api=1&query=%E5%BF%83%E9%BD%8B%E6%A9%8B%E8%B7%91%E8%B7%91%E4%BA%BA", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E5%BF%83%E9%BD%8B%E6%A9%8B%E8%B7%91%E8%B7%91%E4%BA%BA&travelmode=driving"}, {"text": "ğŸ¡ é“é “å €æ‘©å¤©è¼ª", "map_query": "é“é “å €æ‘©å¤©è¼ª ãˆã³ã™ã‚¿ãƒ¯ãƒ¼", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E9%81%93%E9%A0%93%E5%A0%80%E6%91%A9%E5%A4%A9%E8%BC%AA%20%E3%81%88%E3%81%B3%E3%81%99%E3%82%BF%E3%83%AF%E3%83%BC", "map_external": "https://www.google.com/maps/search/?api=1&query=%E9%81%93%E9%A0%93%E5%A0%80%E6%91%A9%E5%A4%A9%E8%BC%AA%20%E3%81%88%E3%81%B3%E3%81%99%E3%82%BF%E3%83%AF%E3%83%BC", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E9%81%93%E9%A0%93%E5%A0%80%E6%91%A9%E5%A4%A9%E8%BC%AA%20%E3%81%88%E3%81%B3%E3%81%99%E3%82%BF%E3%83%AF%E3%83%BC&travelmode=driving"}, {"text": "ğŸ” ç¾åœ‹æ‘", "map_query": "America-mura å¤§é˜ª ç¾åœ‹æ‘", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=America-mura%20%E5%A4%A7%E9%98%AA%20%E7%BE%8E%E5%9C%8B%E6%9D%91", "map_external": "https://www.google.com/maps/search/?api=1&query=America-mura%20%E5%A4%A7%E9%98%AA%20%E7%BE%8E%E5%9C%8B%E6%9D%91", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=America-mura%20%E5%A4%A7%E9%98%AA%20%E7%BE%8E%E5%9C%8B%E6%9D%91&travelmode=driving"}, {"text": "ğŸ›ï¸ å¤§ä¸¸ç™¾è²¨å¿ƒé½‹æ©‹", "map_query": "å¤§ä¸¸å¿ƒæ–æ©‹åº—", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E5%A4%A7%E4%B8%B8%E5%BF%83%E6%96%8E%E6%A9%8B%E5%BA%97", "map_external": "https://www.google.com/maps/search/?api=1&query=%E5%A4%A7%E4%B8%B8%E5%BF%83%E6%96%8E%E6%A9%8B%E5%BA%97", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E5%A4%A7%E4%B8%B8%E5%BF%83%E6%96%8E%E6%A9%8B%E5%BA%97&travelmode=driving"}, {"text": "ğŸˆ C-pla æ‰­è›‹", "map_query": "C-pla å¿ƒæ–æ©‹ç­‹åº—", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=C-pla%20%E5%BF%83%E6%96%8E%E6%A9%8B%E7%AD%8B%E5%BA%97", "map_external": "https://www.google.com/maps/search/?api=1&query=C-pla%20%E5%BF%83%E6%96%8E%E6%A9%8B%E7%AD%8B%E5%BA%97", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=C-pla%20%E5%BF%83%E6%96%8E%E6%A9%8B%E7%AD%8B%E5%BA%97&travelmode=driving"}], "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E9%81%93%E9%A0%93%E5%A0%80%20%E5%BF%83%E9%BD%8B%E6%A9%8B", "map_external": "https://www.google.com/maps/search/?api=1&query=%E9%81%93%E9%A0%93%E5%A0%80%20%E5%BF%83%E9%BD%8B%E6%A9%8B", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E9%81%93%E9%A0%93%E5%A0%80%20%E5%BF%83%E9%BD%8B%E6%A9%8B&travelmode=driving"}]}, {"city_hint": "Osaka", "title": "12/6ï¼ˆå…­ï¼‰ Day2 å¤§é˜ªå¸‚-NEW_ğŸ’", "events": [{"start": "08:00", "end": "09:30", "icon": "ğŸ£", "title": "é»‘é–€å¸‚å ´ Kuromon Ichiba Market", "map_query": "é»‘é–€å¸‚å ´ Kuromon Ichiba Market", "subitems": [{"text": "çŸ³æ©‹é£Ÿå“é—œæ±ç…® Ishibashi Shokuhin", "map_query": "Ishibashi Shokuhin Kuromon", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Ishibashi%20Shokuhin%20Kuromon", "map_external": "https://www.google.com/maps/search/?api=1&query=Ishibashi%20Shokuhin%20Kuromon", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Ishibashi%20Shokuhin%20Kuromon&travelmode=driving"}, {"text": "é»’é–€ã™ã—é…’å ´ èŠ±ç¥ç·æœ¬åº—", "map_query": "é»’é–€ã™ã—é…’å ´ èŠ±ç¥ç·æœ¬åº—", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E9%BB%92%E9%96%80%E3%81%99%E3%81%97%E9%85%92%E5%A0%B4%20%E8%8A%B1%E7%A5%9E%E7%B7%8F%E6%9C%AC%E5%BA%97", "map_external": "https://www.google.com/maps/search/?api=1&query=%E9%BB%92%E9%96%80%E3%81%99%E3%81%97%E9%85%92%E5%A0%B4%20%E8%8A%B1%E7%A5%9E%E7%B7%8F%E6%9C%AC%E5%BA%97", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E9%BB%92%E9%96%80%E3%81%99%E3%81%97%E9%85%92%E5%A0%B4%20%E8%8A%B1%E7%A5%9E%E7%B7%8F%E6%9C%AC%E5%BA%97&travelmode=driving"}, {"text": "ã¾ãã‚ã‚„ Maguroya Kurogin", "map_query": "Maguroya Kurogin Kuromon", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Maguroya%20Kurogin%20Kuromon", "map_external": "https://www.google.com/maps/search/?api=1&query=Maguroya%20Kurogin%20Kuromon", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Maguroya%20Kurogin%20Kuromon&travelmode=driving"}], "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E9%BB%91%E9%96%80%E5%B8%82%E5%A0%B4%20Kuromon%20Ichiba%20Market", "map_external": "https://www.google.com/maps/search/?api=1&query=%E9%BB%91%E9%96%80%E5%B8%82%E5%A0%B4%20Kuromon%20Ichiba%20Market", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E9%BB%91%E9%96%80%E5%B8%82%E5%A0%B4%20Kuromon%20Ichiba%20Market&travelmode=driving"}, {"start": "10:00", "end": "13:00", "icon": "ğŸ¯", "title": "å¤§é˜ªåŸ Osaka Castle", "note": "æ—¥æœ¬æ©‹â†’ä¸­å¤®ç¶ ç·šâ†’è°·ç”ºå››ä¸ç›® ç´„20mins", "map_query": "å¤§é˜ªåŸ Osaka Castle", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E5%A4%A7%E9%98%AA%E5%9F%8E%20Osaka%20Castle", "map_external": "https://www.google.com/maps/search/?api=1&query=%E5%A4%A7%E9%98%AA%E5%9F%8E%20Osaka%20Castle", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E5%A4%A7%E9%98%AA%E5%9F%8E%20Osaka%20Castle&travelmode=driving"}, {"start": "13:30", "end": "15:30", "icon": "ğŸ›", "title": "æ–°ä¸–ç•Œ & é€šå¤©é–£", "map_query": "æ–°ä¸–ç•Œ é€šå¤©é–£ Shinsekai Tsutenkaku", "subitems": [{"text": "æ–°ä¸–ç•Œæœ¬é€šå•†åº—è¡— Shinsekai", "map_query": "Shinsekai Osaka", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Shinsekai%20Osaka", "map_external": "https://www.google.com/maps/search/?api=1&query=Shinsekai%20Osaka", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Shinsekai%20Osaka&travelmode=driving"}, {"text": "é”æ‘©ä¸²ç‚¸ Kushikatsu Daruma", "map_query": "Kushikatsu Daruma Shinsekai", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Kushikatsu%20Daruma%20Shinsekai", "map_external": "https://www.google.com/maps/search/?api=1&query=Kushikatsu%20Daruma%20Shinsekai", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Kushikatsu%20Daruma%20Shinsekai&travelmode=driving"}, {"text": "Usagiya", "map_query": "Usagiya Shinsekai", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Usagiya%20Shinsekai", "map_external": "https://www.google.com/maps/search/?api=1&query=Usagiya%20Shinsekai", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Usagiya%20Shinsekai&travelmode=driving"}], "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E6%96%B0%E4%B8%96%E7%95%8C%20%E9%80%9A%E5%A4%A9%E9%96%A3%20Shinsekai%20Tsutenkaku", "map_external": "https://www.google.com/maps/search/?api=1&query=%E6%96%B0%E4%B8%96%E7%95%8C%20%E9%80%9A%E5%A4%A9%E9%96%A3%20Shinsekai%20Tsutenkaku", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E6%96%B0%E4%B8%96%E7%95%8C%20%E9%80%9A%E5%A4%A9%E9%96%A3%20Shinsekai%20Tsutenkaku&travelmode=driving"}, {"start": "16:00", "end": "21:00", "icon": "ğŸ’", "title": "Seventeen in å¤§é˜ªäº¬ç“·å·¨è›‹", "note": "16:00å¯å…¥å ´\nè¨˜å¾—å¸¶ç¥¨åˆ¸", "map_query": "äº¬ç“·å·¨è›‹ Kyocera Dome Osaka", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E4%BA%AC%E7%93%B7%E5%B7%A8%E8%9B%8B%20Kyocera%20Dome%20Osaka", "map_external": "https://www.google.com/maps/search/?api=1&query=%E4%BA%AC%E7%93%B7%E5%B7%A8%E8%9B%8B%20Kyocera%20Dome%20Osaka", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E4%BA%AC%E7%93%B7%E5%B7%A8%E8%9B%8B%20Kyocera%20Dome%20Osaka&travelmode=driving"}, {"start": "13:00", "icon": "â°", "title": "ç•«é£›æ©Ÿä½å­æé†’", "note": "13:00 é–‹æ”¾åŠƒä½", "important": true}]}, {"city_hint": "Osaka", "title": "12/7ï¼ˆæ—¥ï¼‰ Day3 å‹å°¾å¯º-æ¢…ç”°", "events": [{"start": "08:00", "end": "09:00", "icon": "ğŸ³", "title": "æ—©åˆé¤", "subitems": [{"text": "éº¥ç•¶å‹ McDonald's", "map_query": "McDonald's Shinsaibashi", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=McDonald%27s%20Shinsaibashi", "map_external": "https://www.google.com/maps/search/?api=1&query=McDonald%27s%20Shinsaibashi", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=McDonald%27s%20Shinsaibashi&travelmode=driving"}, {"text": "å®¢ç¾å¤š Komeda Coffee è¥¿å¿ƒé½‹æ©‹åº—", "map_query": "Komeda Coffee Shinsaibashi", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Komeda%20Coffee%20Shinsaibashi", "map_external": "https://www.google.com/maps/search/?api=1&query=Komeda%20Coffee%20Shinsaibashi", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Komeda%20Coffee%20Shinsaibashi&travelmode=driving"}, {"text": "Lawsonï¼ˆé£¯åº—æ—ï¼‰", "map_query": "Lawson Shinsaibashi", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Lawson%20Shinsaibashi", "map_external": "https://www.google.com/maps/search/?api=1&query=Lawson%20Shinsaibashi", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Lawson%20Shinsaibashi&travelmode=driving"}]}, {"start": "11:00", "end": "14:30", "icon": "â›©ï¸", "title": "å‹å°¾å¯º Katsuo-ji Temple", "note": "å»ç¨‹10:40/11:20\nå›ç¨‹13:48/14:48\né–€ç¥¨500Â¥\né è¨ˆåœç•™1.5hr", "map_query": "å‹å°¾å¯º Katsuo-ji Temple", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E5%8B%9D%E5%B0%BE%E5%AF%BA%20Katsuo-ji%20Temple", "map_external": "https://www.google.com/maps/search/?api=1&query=%E5%8B%9D%E5%B0%BE%E5%AF%BA%20Katsuo-ji%20Temple", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E5%8B%9D%E5%B0%BE%E5%AF%BA%20Katsuo-ji%20Temple&travelmode=driving"}, {"start": "15:00", "end": "16:30", "icon": "ğŸ¥£", "title": "æ¢…ç”° åˆé¤", "map_query": "Umeda Osaka lunch", "subitems": [{"text": "epais ç‚¸è±¬æ’", "map_query": "epais Umeda", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=epais%20Umeda", "map_external": "https://www.google.com/maps/search/?api=1&query=epais%20Umeda", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=epais%20Umeda&travelmode=driving"}, {"text": "new babe ç‚¸è±¬æ’", "map_query": "New Babe Umeda", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=New%20Babe%20Umeda", "map_external": "https://www.google.com/maps/search/?api=1&query=New%20Babe%20Umeda", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=New%20Babe%20Umeda&travelmode=driving"}], "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Umeda%20Osaka%20lunch", "map_external": "https://www.google.com/maps/search/?api=1&query=Umeda%20Osaka%20lunch", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Umeda%20Osaka%20lunch&travelmode=driving"}, {"start": "17:00", "end": "19:00", "icon": "ğŸ°", "title": "æ¢…ç”° ç”œé» & é€›è¡—", "map_query": "æ¢…ç”° ç”œé» é€›è¡—", "subitems": [{"text": "Grenier åƒå±¤é…¥", "map_query": "Grenier Umeda Osaka", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Grenier%20Umeda%20Osaka", "map_external": "https://www.google.com/maps/search/?api=1&query=Grenier%20Umeda%20Osaka", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Grenier%20Umeda%20Osaka&travelmode=driving"}, {"text": "HARBS", "map_query": "HARBS Umeda", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=HARBS%20Umeda", "map_external": "https://www.google.com/maps/search/?api=1&query=HARBS%20Umeda", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=HARBS%20Umeda&travelmode=driving"}, {"text": "LUCUA", "map_query": "LUCUA Osaka", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=LUCUA%20Osaka", "map_external": "https://www.google.com/maps/search/?api=1&query=LUCUA%20Osaka", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=LUCUA%20Osaka&travelmode=driving"}, {"text": "HEP FIVE", "map_query": "HEP FIVE Osaka", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=HEP%20FIVE%20Osaka", "map_external": "https://www.google.com/maps/search/?api=1&query=HEP%20FIVE%20Osaka", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=HEP%20FIVE%20Osaka&travelmode=driving"}, {"text": "å¤§ä¸¸æ¢…ç”°ï¼ˆå‰ä¼Šå¡å“‡ï¼‰", "map_query": "Daimaru Umeda", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Daimaru%20Umeda", "map_external": "https://www.google.com/maps/search/?api=1&query=Daimaru%20Umeda", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Daimaru%20Umeda&travelmode=driving"}], "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E6%A2%85%E7%94%B0%20%E7%94%9C%E9%BB%9E%20%E9%80%9B%E8%A1%97", "map_external": "https://www.google.com/maps/search/?api=1&query=%E6%A2%85%E7%94%B0%20%E7%94%9C%E9%BB%9E%20%E9%80%9B%E8%A1%97", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E6%A2%85%E7%94%B0%20%E7%94%9C%E9%BB%9E%20%E9%80%9B%E8%A1%97&travelmode=driving"}, {"start": "19:00", "icon": "ğŸ¥£", "title": "æ¢…ç”° æ™šé¤", "map_query": "æ¢…ç”° æ™šé¤", "subitems": [{"text": "ã—ã‚ƒã¶ç¦ª å£½å–œç‡’", "map_query": "Shabuzen Umeda", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Shabuzen%20Umeda", "map_external": "https://www.google.com/maps/search/?api=1&query=Shabuzen%20Umeda", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Shabuzen%20Umeda&travelmode=driving"}, {"text": "ç‚¸ç‰›å…ƒæ‘", "map_query": "Gyukatsu Motomura Umeda", "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Gyukatsu%20Motomura%20Umeda", "map_external": "https://www.google.com/maps/search/?api=1&query=Gyukatsu%20Motomura%20Umeda", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=Gyukatsu%20Motomura%20Umeda&travelmode=driving"}], "map_embed": "https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=%E6%A2%85%E7%94%B0%20%E6%99%9A%E9%A4%90", "map_external": "https://www.google.com/maps/search/?api=1&query=%E6%A2%85%E7%94%B0%20%E6%99%9A%E9%A4%90", "nav_external": "https://www.google.com/maps/dir/?api=1&destination=%E6%A2%85%E7%94%B0%20%E6%99%9A%E9%A4%90&travelmode=driving"}]}, {"city_hint": "Osaka", "title": "12/8ï¼ˆä¸€ï¼‰ Day4 å›å®¶ğŸ‡¹ğŸ‡¼", "events": [{"start": "08:00", "icon": "ğŸš„", "title": "é€€æˆ¿å‰å¾€æ©Ÿå ´", "note": "å—æµ·ç‰¹æ€¥ â†’ é—œè¥¿æ©Ÿå ´\n8:00 / 8:30 / 9:00", "important": true}, {"start": "12:55", "end": "15:05", "icon": "âœˆï¸", "title": "å›ç¨‹ç­æ©Ÿ BR131", "note": "KIX(T1)12:55 â†’ TPE(T2)15:05"}]}]};

/* ---------- Tabs ---------- */
function showTab(tab) {
  document.getElementById("tab-itin").classList.toggle("active", tab==="itin");
  document.getElementById("tab-tools").classList.toggle("active", tab==="tools");
  document.getElementById("main").style.display = tab==="itin" ? "block" : "none";
  document.getElementById("tools").classList.toggle("active", tab==="tools");
}

/* ---------- Itinerary (time order) ---------- */
function toMinutes(t) {
  if(!t) return 0;
  const [h,m] = t.split(":").map(Number);
  return h*60 + m;
}

function renderSubitem(si) {
  const mapBtn = si.map_embed ? `<button class="btn map" onclick="event.stopPropagation(); openMapModal('${escapeJs(si.text||'åœ°åœ–')}','${escapeJs(si.map_embed)}')">åœ°åœ–</button>` : "";
  const navBtn = si.nav_external ? `<a class="btn nav" href="${si.nav_external}" target="_blank" rel="noopener">å°èˆª</a>` : "";
  const searchBtn = si.map_query ? `<a class="btn search" href="https://www.google.com/search?q=${encodeURIComponent(si.map_query+' æ”»ç•¥')}" target="_blank" rel="noopener">æ”»ç•¥</a>` : "";
  return `
    <div class="subitem">
      <div>${escapeHtml(si.text||"")}</div>
      <div class="flex gap-1">${mapBtn}${navBtn}${searchBtn}</div>
    </div>`;
}

function renderEvent(ev) {
  const time = ev.end ? `${ev.start}â€“${ev.end}` : (ev.start||"");
  const impBadge = ev.important ? `<span class="important-badge">Important</span>` : "";
  const mapBtn = ev.map_embed ? `<button class="btn map" onclick="event.stopPropagation(); openMapModal('${escapeJs(ev.title||'åœ°åœ–')}','${escapeJs(ev.map_embed)}')">åœ°åœ–</button>` : "";
  const navBtn = ev.nav_external ? `<a class="btn nav" href="${ev.nav_external}" target="_blank" rel="noopener">å°èˆª</a>` : "";
  const searchBtn = ev.map_query ? `<a class="btn search" href="https://www.google.com/search?q=${encodeURIComponent(ev.map_query+' æ”»ç•¥')}" target="_blank" rel="noopener">æ”»ç•¥</a>` : "";
  const subHtml = (ev.subitems||[]).length ? `<div class="sub">${(ev.subitems||[]).map(renderSubitem).join("")}</div>` : "";
  return `
  <article class="card ${ev.important?'important':''}">
    <div class="time">${time} ${impBadge}</div>
    <div class="row">
      <div class="h3">${escapeHtml(ev.icon||"")} ${escapeHtml(ev.title||"")}</div>
      <div class="flex gap-2">${mapBtn}${navBtn}${searchBtn}</div>
    </div>
    ${ev.note?`<div class="note">${escapeHtml(ev.note)}</div>`:""}
    ${subHtml}
  </article>`;
}

function renderDay(day, di) {
  const events = (day.events||[]).slice().sort((a,b)=>toMinutes(a.start)-toMinutes(b.start));
  const imps = events.filter(e=>e.important);
  const impBox = imps.length ? `
    <div class="today-imp show" id="todayImp-${di}">
      ğŸ”¶ ä»Šæ—¥æé†’<br>
      ${imps.map(e=>`${escapeHtml(e.start||'')} â€” ${escapeHtml(e.title||'')}`).join("<br>")}
    </div>` : `<div class="today-imp" id="todayImp-${di}"></div>`;
  return `
    <section class="day ${di===0?"active":""}" id="day-${di}">
      <div class="dayhead">
        <div class="daytitle">
          <span>${escapeHtml(day.title||"")}</span>
          <span class="weather" id="weather-${di}">å¤©æ°£è®€å–ä¸­â€¦</span>
        </div>
        ${impBox}
      </div>
      ${events.map(renderEvent).join("")}
    </section>
  `;
}

function renderItinerary() {
  const main = document.getElementById("main");
  main.innerHTML = `
    <div class="pills">
      ${DATA.days.map((d,i)=>`<button class="pill" onclick="showDay(${i})">Day${i+1}</button>`).join("")}
    </div>
    ${DATA.days.map((d,i)=>renderDay(d,i)).join("")}
  `;
  updateTodayImportant(0);
}

function updateTodayImportant(activeIndex){
  document.querySelectorAll(".today-imp").forEach((el,i)=>{
    if(el.classList.contains("show")){
      el.style.display = i===activeIndex ? "block" : "none";
    }
  });
}

function showDay(di) {
  document.querySelectorAll(".day").forEach((el,i)=>el.classList.toggle("active", i===di));
  updateTodayImportant(di);
  window.scrollTo({top:0, behavior:"smooth"});
}

/* ---------- Weather ---------- */
async function loadWeatherForDay(day, di) {
  const box = document.getElementById("weather-"+di);
  try {
    const q = encodeURIComponent(day.city_hint || "Osaka");
    const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`, { headers:{"Accept-Language":"ja,en,zh-TW"} }).then(r=>r.json());
    if(!geo || !geo[0]) throw new Error("geo");
    const lat = geo[0].lat, lon = geo[0].lon;
    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&timezone=Asia%2FTokyo`).then(r=>r.json());
    const t = w?.current?.temperature_2m; const wind = w?.current?.wind_speed_10m; const code = w?.current?.weather_code;
    box.textContent = `ğŸŒ¡ï¸ ${t}Â°C  ğŸŒ¬ï¸ ${wind}m/s  (${codeToText(code)})`;
  } catch(e) { box.textContent = "å¤©æ°£æš«æ™‚è®€ä¸åˆ°"; }
}
function codeToText(code) {
  const map = {0:"æ™´",1:"å¤šé›²",2:"å¤šé›²",3:"é™°",45:"éœ§",48:"éœ§",51:"æ¯›æ¯›é›¨",53:"æ¯›æ¯›é›¨",55:"æ¯›æ¯›é›¨",61:"å°é›¨",63:"ä¸­é›¨",65:"å¤§é›¨",71:"å°é›ª",73:"ä¸­é›ª",75:"å¤§é›ª",80:"é™£é›¨",81:"é™£é›¨",82:"è±ªé›¨",95:"é›·é›¨"};
  return map[code] || "å¤©æ°£";
}
async function loadAllWeather() {
  for(let i=0;i<DATA.days.length;i++) loadWeatherForDay(DATA.days[i], i);
}

/* ---------- è¨˜å¸³ï¼ˆå…±åŒè¨˜å¸³ç‰ˆï¼‰ ---------- */
const FX_KEY = "osakaFxRateV9milktea";
const PAYERS = ["ç¾Š","ç†™"];
let budgetItems = []; // æœƒæ”¾å¾ Supabase æ’ˆå›ä¾†çš„è³‡æ–™

function renderTools() {
  const tools = document.getElementById("tools");
  tools.innerHTML = `
    <div class="tools-card">
      <div class="tools-title">ğŸ§¾ è¨˜å¸³ / é ç®—ï¼ˆJPY â†’ TWD è‡ªå‹•çµç®—ï¼‰</div>
      <div class="muted">
        å…±åŒè¨˜å¸³ï¼šä»˜æ¬¾äººå›ºå®šã€Œç¾Šã€ç†™ã€ï¼Œè³‡æ–™æœƒåŒæ­¥åˆ°é›²ç«¯ï¼ˆSupabaseï¼‰ã€‚
      </div>

      <div class="mt-2 grid grid-cols-2 gap-2">
        <div>
          <div class="muted mb-1">JPYâ†’TWD åŒ¯ç‡</div>
          <input id="fxRateInput" type="number" step="0.001" />
        </div>
        <div class="flex items-end">
          <button class="btn map w-full justify-center" onclick="resetBudget()">æ¸…ç©ºå…¨éƒ¨</button>
        </div>
      </div>

      <div id="budget-list" class="mt-2"></div>

      <div class="mt-2 flex gap-2">
        <button class="btn map" onclick="addBudgetRow()">æ–°å¢é …ç›®</button>
        <button class="btn nav" onclick="reloadBudget()">é‡æ–°æ•´ç†</button>
      </div>

      <div id="budget-total" class="budget-total"></div>
      <div id="budget-summary" class="mt-2 text-sm"></div>
      <div id="budget-settlement" class="mt-2 text-sm font-semibold"></div>
      <div id="budget-status" class="mt-2 text-xs text-slate-500"></div>
    </div>
  `;
  initFxRate();
  initBudget();
}

function initFxRate() {
  const fx = document.getElementById("fxRateInput");
  const saved = Number(localStorage.getItem(FX_KEY));
  fx.value = saved || 0.21;
  fx.oninput = () => {
    localStorage.setItem(FX_KEY, String(Number(fx.value||0)));
    calcSettlement();
  };
}

function setBudgetStatus(msg) {
  const box = document.getElementById("budget-status");
  if (box) box.textContent = msg || "";
}

/* ---- Supabase ç›¸é—œ ---- */
async function fetchBudgetFromSupabase() {
  if (!supabaseClient) {
    setBudgetStatus("âš ï¸ Supabase æœªè¨­å®šï¼Œåƒ…æœ¬æ©Ÿå¯ç”¨ã€‚");
    return [];
  }
  setBudgetStatus("é›²ç«¯è³‡æ–™è¼‰å…¥ä¸­â€¦");
  const { data, error } = await supabaseClient
    .from('budgets')
    .select('*')
    .eq('trip_id', TRIP_ID)
    .order('created_at', { ascending: true });

  if (error) {
    console.error(error);
    setBudgetStatus("âš ï¸ é›²ç«¯è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚");
    return [];
  }
  setBudgetStatus("âœ… å·²èˆ‡é›²ç«¯åŒæ­¥ã€‚");
  return data || [];
}

async function insertBudgetItem(note="", amount=0, payer=PAYERS[0]) {
  if (!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .insert([{ trip_id: TRIP_ID, note, amount: Number(amount)||0, payer }]);
  if (error) console.error(error);
}

async function updateBudgetItem(id, fields) {
  if (!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .update(fields)
    .eq('id', id);
  if (error) console.error(error);
}

async function deleteBudgetItem(id) {
  if (!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .delete()
    .eq('id', id);
  if (error) console.error(error);
}

async function clearAllBudget() {
  if (!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .delete()
    .eq('trip_id', TRIP_ID);
  if (error) console.error(error);
}

/* ---- è¨˜å¸³æ“ä½œæµç¨‹ ---- */
async function initBudget() {
  await reloadBudget();
  setupBudgetRealtime();
}

async function reloadBudget() {
  budgetItems = await fetchBudgetFromSupabase();
  renderBudget();
  calcSettlement();
}

function renderBudget() {
  const list = document.getElementById("budget-list"); 
  if(!list) return;
  list.innerHTML = budgetItems.map((it,i)=>`
    <div class="budget-row">
      <input data-budget-note placeholder="é …ç›®" value="${escapeAttr(it.note||"")}" 
        oninput="onBudgetFieldChange('${it.id}', 'note', this.value)">
      <input placeholder="é‡‘é¡(JPY)" type="number" value="${it.amount||0}" 
        oninput="onBudgetFieldChange('${it.id}', 'amount', this.value)">
      <select onchange="onBudgetFieldChange('${it.id}', 'payer', this.value)">
        ${PAYERS.map(p=>`<option value="${p}" ${p===(it.payer||PAYERS[0])?"selected":""}>${p}</option>`).join("")}
      </select>
      <button class="btn" onclick="deleteBudget('${it.id}')" style="grid-column:1/-1; justify-content:center;">åˆªé™¤</button>
    </div>
  `).join("");

  const total = budgetItems.reduce((s,it)=>s+(Number(it.amount)||0),0);
  const totalBox=document.getElementById("budget-total");
  if(totalBox) totalBox.textContent = `åˆè¨ˆï¼š${total.toLocaleString()} JPY`;
}

async function addBudgetRow() {
  await insertBudgetItem("", 0, PAYERS[0]);
  await reloadBudget();
  focusLastRow();
}

async function resetBudget() {
  if(!confirm("ç¢ºå®šè¦æ¸…ç©ºé›²ç«¯è¨˜å¸³å—ï¼Ÿ")) return;
  await clearAllBudget();
  budgetItems = [];
  renderBudget();
  calcSettlement();
}

function onBudgetFieldChange(id, field, value) {
  const idx = budgetItems.findIndex(x=>x.id === id);
  if (idx === -1) return;
  if (field === "amount") {
    budgetItems[idx].amount = Number(value||0);
  } else {
    budgetItems[idx][field] = value;
  }
  // å³æ™‚æ›´æ–°é›²ç«¯ï¼ˆå¯ä»¥è¦–æƒ…æ³ debounceï¼‰
  updateBudgetItem(id, {[field]: field==="amount" ? Number(value||0) : value});
  calcSettlement();
}

async function deleteBudget(id) {
  await deleteBudgetItem(id);
  budgetItems = budgetItems.filter(x=>x.id !== id);
  renderBudget();
  calcSettlement();
}

function focusLastRow() {
  const rows = document.querySelectorAll("[data-budget-note]");
  if(rows.length) rows[rows.length-1].focus();
}

/* ---- çµç®—é‚è¼¯ï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„ï¼‰ ---- */
function calcSettlement() {
  const items = budgetItems || [];
  const fx = Number(localStorage.getItem(FX_KEY) || 0.21);
  const totalJPY = items.reduce((s,it)=>s+(Number(it.amount)||0),0);
  const members = PAYERS.slice();
  const n = members.length;
  const shareJPY = n ? totalJPY / n : 0;

  const paidBy = Object.fromEntries(members.map(p=>[p,0]));
  items.forEach(it=>{ 
    const p=(it.payer||"").trim(); 
    if(paidBy[p]!=null) paidBy[p]+=Number(it.amount)||0; 
  });

  const net = members.map(p=>({name:p, paid:paidBy[p], net:paidBy[p]-shareJPY}));
  const creditors = net.filter(x=>x.net>0.01).sort((a,b)=>b.net-a.net);
  const debtors = net.filter(x=>x.net<-0.01).sort((a,b)=>a.net-b.net);

  const transfers=[];
  let ci=0, di=0;
  while(ci<creditors.length && di<debtors.length) {
    const c=creditors[ci], d=debtors[di];
    const amt = Math.min(c.net, -d.net);
    transfers.push({from:d.name, to:c.name, amount:amt});
    c.net-=amt; d.net+=amt;
    if(c.net<=0.01) ci++;
    if(d.net>=-0.01) di++;
  }

  const sumBox=document.getElementById("budget-summary");
  if(sumBox) {
    sumBox.innerHTML = `
      <div class="mt-2">
        <div class="font-extrabold">ä»˜æ¬¾çµ±è¨ˆ</div>
        ${members.map(p=>`<div class="flex justify-between"><span>${escapeHtml(p)}</span><span class="font-black">${(paidBy[p]||0).toLocaleString()} JPY / ${(paidBy[p]*fx).toFixed(0)} TWD</span></div>`).join("")}
        <div class="flex justify-between mt-1 border-t pt-1"><span>æ¯äººå¹³å‡</span><span class="font-black">${shareJPY.toFixed(0)} JPY / ${(shareJPY*fx).toFixed(0)} TWD</span></div>
      </div>
    `;
  }

  const setBox=document.getElementById("budget-settlement");
  if(setBox) {
    if(!transfers.length) {
      setBox.innerHTML = `<div class="mt-2 font-extrabold">âœ… å·²å¹³è¡¡ï¼Œä¸ç”¨äº’ç›¸è½‰å¸³</div>`;
    } else {
      setBox.innerHTML = `
        <div class="mt-2 font-extrabold">çµç®—å»ºè­°</div>
        ${transfers.map(t=>`<div class="flex justify-between"><span>${escapeHtml(t.from)} â†’ ${escapeHtml(t.to)}</span><span class="font-black">${t.amount.toFixed(0)} JPY / ${(t.amount*fx).toFixed(0)} TWD</span></div>`).join("")}
      `;
    }
  }
}

/* ---- Supabase Realtimeï¼šå¤šè£ç½®åŒæ­¥ ---- */
function setupBudgetRealtime() {
  if (!supabaseClient) return;
  supabaseClient
    .channel('budgets-channel')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'budgets', filter: `trip_id=eq.${TRIP_ID}` },
      payload => {
        // æœ‰ä»»ä½•æ–°å¢/ä¿®æ”¹/åˆªé™¤ â†’ é‡æ–°æŠ“ä¸€æ¬¡
        reloadBudget();
      }
    )
    .subscribe();
}

/* ---------- Map Modal ---------- */
const mapModal=document.getElementById("mapModal");
const mapModalMap=document.getElementById("mapModalMap");
const mapModalTitle=document.getElementById("mapModalTitle");
function openMapModal(title, embedUrl) {
  mapModalTitle.textContent=title||"åœ°åœ–"; mapModalMap.innerHTML="";
  if(navigator.onLine && embedUrl) {
    const iframe=document.createElement("iframe"); iframe.src=embedUrl; iframe.className="w-full h-full border-0"; iframe.loading="lazy"; mapModalMap.appendChild(iframe);
  } else {
    mapModalMap.innerHTML = `<div class="w-full h-full flex items-center justify-center text-white text-sm font-bold">é›¢ç·šä¸­</div>`;
  }
  mapModal.classList.add("show");
}
function closeMapModal() { mapModal.classList.remove("show"); mapModalMap.innerHTML=""; }
mapModal.addEventListener("click",(e)=>{ if(e.target===mapModal) closeMapModal(); });

/* ---------- Trip Modal (iframe w/ fallback) ---------- */
const tripModal=document.getElementById("tripModal");
const tripModalBody=document.getElementById("tripModalBody");
const tripModalTitle=document.getElementById("tripModalTitle");
function openTripModal(label, url){
  tripModalTitle.textContent = `TRIP.com ${label}`;
  tripModalBody.innerHTML="";
  if(navigator.onLine){
    const iframe=document.createElement("iframe");
    iframe.src=url; iframe.className="w-full h-full border-0"; iframe.loading="lazy";
    iframe.onerror = ()=>{ window.open(url, "_blank"); closeTripModal(); };
    tripModalBody.appendChild(iframe);
    setTimeout(()=>{
      try{
        const doc = iframe.contentDocument;
        if(!doc || (doc.body && (doc.body.innerText.includes("refused") || doc.body.innerText.includes("denied")))){
          window.open(url,"_blank"); closeTripModal();
        }
      }catch(e){
        window.open(url,"_blank"); closeTripModal();
      }
    }, 900);
  }else{
    tripModalBody.innerHTML = `<div class="w-full h-full flex items-center justify-center text-white text-sm font-bold">é›¢ç·šä¸­ï¼Œç„¡æ³•è¼‰å…¥ TRIP.com</div>`;
  }
  tripModal.classList.add("show");
}
function closeTripModal(){ tripModal.classList.remove("show"); tripModalBody.innerHTML=""; }
tripModal.addEventListener("click",(e)=>{ if(e.target===tripModal) closeTripModal(); });

/* ---------- Hotel Modal + room number ---------- */
const hotelModal=document.getElementById("hotelModal");
const ROOM_KEY="osakaRoomNumberV9milktea";
function openHotelModal() {
  hotelModal.classList.add("show");
  const input=document.getElementById("roomNumberInput");
  input.value = localStorage.getItem(ROOM_KEY) || "";
  input.oninput=()=>localStorage.setItem(ROOM_KEY, input.value);
}
function closeHotelModal() { hotelModal.classList.remove("show"); }
hotelModal.addEventListener("click",(e)=>{ if(e.target===hotelModal) closeHotelModal(); });

/* ---------- Helpers ---------- */
function escapeHtml(str) { return (str||"").replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
function escapeAttr(str) { return escapeHtml(str).replace(/"/g,"&quot;"); }
function escapeJs(str) { return (str||"").replace(/'/g,"\\'"); }

/* ---------- boot ---------- */
renderItinerary();
renderTools();
loadAllWeather();
</script>
</body>
</html>

