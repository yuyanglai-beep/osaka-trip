<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Osaka è¡Œç¨‹ & è¨˜å¸³ App</title>

  <!-- PWA Manifestï¼ˆç›¸å°è·¯å¾‘ for GitHub Pagesï¼‰ -->
  <link rel="manifest" href="./manifest.json" />

  <style>
    :root {
      --blue-main: #3b82f6;
      --blue-soft: #dbeafe;
      --blue-border: #93c5fd;
      --bg: #f7f3ee;
      --text-main: #333;
      --card-bg: #fff;
      --radius: 12px;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      color: var(--text-main);
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 12px 16px 80px;
    }

    header { text-align: center; padding: 8px 0 12px; }
    header h1 { margin: 0; font-size: 20px; }

    /* Tab Buttons */
    .tab-bar {
      display: flex; gap: 6px; margin: 12px 0;
    }
    .tab-btn {
      flex: 1; padding: 8px 0; border-radius: 999px;
      border: none; cursor: pointer; font-weight: 600;
      background: var(--blue-soft); color: var(--blue-main);
    }
    .tab-btn.active { background: var(--blue-main); color:#fff; }

    /* Tabs Content */
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Days Selector */
    .day-switcher {
      display:flex; gap:8px;
      overflow-x:auto; padding-bottom:4px;
    }
    .day-chip {
      padding: 6px 10px; white-space: nowrap;
      border-radius: 999px; border: 1px solid var(--blue-border);
      background:#fff; cursor:pointer; font-size:13px;
    }
    .day-chip.active { background: var(--blue-main); color:#fff; }

    /* Highlight / Important Notice */
    .highlight-card {
      background: var(--blue-soft); padding: 10px;
      border-radius: var(--radius); box-shadow: var(--shadow);
      margin: 12px 0; font-size: 13px;
    }

    /* Event Cards */
    .event-card {
      background:#fff; padding:10px;
      margin-bottom:8px; border-left:3px solid var(--blue-main);
      border-radius: var(--radius); cursor:pointer;
    }
    .event-time { font-size:12px; color:#555; }
    .event-title { font-size:15px; font-weight:bold; }
    .event-place { font-size:13px; color:#666; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset:0; background: rgba(0,0,0,0.4);
      display:none; align-items:center; justify-content:center;
      z-index:50; padding:16px;
    }
    .modal-backdrop.show { display:flex; }

    .modal {
      background:#fff; width:100%; max-width:480px;
      border-radius: var(--radius); overflow-y:auto;
      max-height:90vh; box-shadow:0 10px 32px rgba(0,0,0,0.25);
    }
    .modal img {
      width: 100%; height: 200px; object-fit: cover;
      background:#ddd;
    }
    .modal-body { padding:12px; }
    .btn-blue {
      background: var(--blue-main); color:#fff;
      border-radius: var(--radius); padding:6px 12px;
      border:none; cursor:pointer;
    }

    /* Info Cards */
    .info-card {
      background:#fff; padding:12px;
      border-radius: var(--radius); box-shadow: var(--shadow);
      margin-bottom:14px; font-size:13px;
    }
    .info-row { margin-bottom:6px; }

    /* Expense */
    .expense-item {
      display:flex; justify-content:space-between;
      padding:6px 0; border-bottom:1px solid #eee;
      align-items:center;
    }
    .expense-note { font-size:12px; color:#666; }

    /* 3 dots menu */
    .menu-btn {
      cursor:pointer; font-size:18px;
      padding:0 6px; color:#555;
    }
    .menu-panel {
      position:absolute;
      background:#fff; border:1px solid #ddd;
      border-radius:8px; padding:6px 0;
      width:120px; box-shadow:0 4px 18px rgba(0,0,0,0.12);
      display:none; z-index:80;
    }
    .menu-panel.show { display:block; }
    .menu-item {
      padding:6px 12px; cursor:pointer;
    }
    .menu-item:hover { background:#f3f4f6; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>å¤§é˜ªè¡Œç¨‹ & è¨˜å¸³</h1>
  </header>

  <!-- Tab Buttons -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="itinerary">è¡Œç¨‹</button>
    <button class="tab-btn" data-tab="info">è³‡è¨Š ï¼† è¨˜å¸³</button>
  </div>

  <!-- è¡Œç¨‹ TAB -->
  <div class="tab-content active" id="tab-itinerary">
    <div class="day-switcher" id="day-switcher"></div>
    <div id="day-content"></div>
  </div>

  <!-- è³‡è¨Š TAB -->
  <div class="tab-content" id="tab-info">

    <!-- èˆªç­è³‡è¨Š -->
    <div class="info-card">
      <strong>âœˆ èˆªç­è³‡è¨Š</strong>
      <div class="info-row">
        å»ç¨‹ GK050
        <button class="btn-blue"
          onclick="window.open('https://www.trip.com/webapp/flight/schedule/detail.html?isHideNavBar=YES&origin=210&useCTHybrid=1&flightNo=GK050&dcode=TPE&acode=KIX&queryDate=2025-12-05&queryTime=02:30:00&locale=zh-TW')">
          æŸ¥çœ‹
        </button>
      </div>
      <div class="info-row">
        å›ç¨‹ BR131
        <button class="btn-blue"
          onclick="window.open('https://www.trip.com/webapp/flight/schedule/detail.html?isHideNavBar=YES&origin=210&useCTHybrid=1&flightNo=BR131&dcode=KIX&acode=TPE&queryDate=2025-12-08&queryTime=12:55:00&locale=zh-TW')">
          æŸ¥çœ‹
        </button>
      </div>
    </div>

    <!-- ä½å®¿ -->
    <div class="info-card">
      <strong>ğŸ  ä½å®¿</strong><br>
      Dormy Inn PREMIUM Nanba ANNEX
      <div class="info-row">
        æˆ¿è™Ÿï¼š<input id="room-number" style="padding:4px 6px; width:80px;">
      </div>
      <button class="btn-blue"
        onclick="window.open('https://www.google.com/maps/search/?api=1&query=Dormy+Inn+Premium+Namba+Annex')">
        åœ°åœ–
      </button>
    </div>

    <!-- è¨˜å¸³å€ï¼ˆç¬¬ 3 éƒ¨åˆ†æœƒè£œä¸Š JSï¼‰ -->
    <div class="info-card" id="expense-section">
      <strong>ğŸ’´ æ–°å¢æ”¯å‡ºï¼ˆJPYï¼‰</strong>
      <div id="rate-info" style="font-size:12px;color:#555;margin:4px 0;">åŒ¯ç‡è®€å–ä¸­...</div>

      <form id="expense-form">
        <input type="number" id="exp-amount" placeholder="é‡‘é¡ï¼ˆJPYï¼‰" required />
        <select id="exp-payer">
          <option value="ç¾Š">ç¾Š</option>
          <option value="ç†™">ç†™</option>
        </select>
        <input type="text" id="exp-note" placeholder="å‚™è¨»ï¼ˆé¤è²» / äº¤é€šï¼‰"/>
        <button class="btn-blue" style="width:100%;margin-top:6px;">æ–°å¢</button>
      </form>

      <div id="expense-list" style="margin-top:10px;"></div>
      <div id="expense-total" style="margin-top:6px; font-weight:bold;"></div>
      <div id="settlement" style="margin-top:10px; background:#e0edff; padding:8px; border-radius:8px;"></div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal">
    <img id="modal-img" src="" alt="æ™¯é»åœ–ç‰‡">
    <div class="modal-body">
      <div id="modal-title" style="font-size:16px;font-weight:700;"></div>
      <div id="modal-sub" style="font-size:12px;color:#555;margin-top:3px;"></div>
      <div id="modal-desc" style="margin:8px 0;"></div>

      <button class="btn-blue" id="modal-nav">åœ°åœ–</button>
      <button class="btn-blue" id="modal-close" style="background:#777;margin-left:6px;">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------------------------------------------------------
   Wikipedia åœ–ç‰‡ APIï¼ˆå… keyï¼‰
--------------------------------------------------------- */
async function fetchWikipediaImage(keyword) {
  try {
    // Step 1: æ‰¾é é¢
    const searchUrl = `https://zh.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(keyword)}&format=json&origin=*`;
    const searchRes = await fetch(searchUrl).then(r => r.json());
    if (!searchRes.query.search.length) return null;

    const pageId = searchRes.query.search[0].pageid;

    // Step 2: å–ä¸»åœ–
    const pageUrl = `https://zh.wikipedia.org/w/api.php?action=query&pageids=${pageId}&prop=pageimages&pithumbsize=800&format=json&origin=*`;
    const pageRes = await fetch(pageUrl).then(r => r.json());

    const pages = pageRes.query.pages;
    const page = pages[pageId];
    return page.thumbnail?.source || null;

  } catch (err) {
    console.warn("Wiki Image error:", err);
    return null;
  }
}

/* ---------------------------------------------------------
   å°éŠ€åŒ¯ç‡æŠ“å–
--------------------------------------------------------- */
let rateJPYtoTWD = 0;

async function fetchRate() {
  try {
    const res = await fetch("https://rate.bot.com.tw/xrt?Lang=zh-TW");
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, "text/html");

    const rows = doc.querySelectorAll("tbody tr");
    for (let r of rows) {
      if (r.innerText.includes("JPY")) {
        const tds = r.querySelectorAll("td");
        rateJPYtoTWD = Number(tds[5].innerText);
      }
    }

    document.getElementById("rate-info").textContent =
      `ç›®å‰åŒ¯ç‡ï¼šç´„ 1 JPY = ${rateJPYtoTWD} TWD`;

  } catch {
    rateJPYtoTWD = 0.2;
    document.getElementById("rate-info").textContent =
      "åŒ¯ç‡è®€å–å¤±æ•—ï¼Œæš«ç”¨ 0.2 è¨ˆç®—";
  }
}

/* ---------------------------------------------------------
   è¡Œç¨‹è³‡æ–™ï¼ˆä½ ä¹‹å¾Œå¯ä»¥æ“´å…… Day3 / Day4ï¼‰
--------------------------------------------------------- */
const itinerary = [
  {
    dayId: "day1",
    date: "12/5ï¼ˆäº”ï¼‰",
    highlight: "å¤§ä¸¸ç™¾è²¨ 20:00 é—œé–€ï¼Œè¦é€›å…ˆé€›ç™¾è²¨ï¼",
    events: [
      {
        time: "02:30â€“06:00",
        title: "GK050 æ¡ƒåœ’ â†’ é—œè¥¿",
        placeName: "Kansai Airport",
        description: "ç´…çœ¼ç­æ©Ÿï¼ŒæŠµé”å¾Œæ­å—æµ·ç‰¹æ€¥è‡³é›£æ³¢ã€‚",
        mapsQuery: "Kansai Airport"
      },
      {
        time: "07:30â€“09:00",
        title: "å—æµ·ç‰¹æ€¥ â†’ é›£æ³¢",
        placeName: "Nankai Namba Station",
        description: "ç­æ¬¡å¤šã€ç¾å ´è²·ä¹Ÿå¯ä»¥ã€‚",
        mapsQuery: "Nankai Namba Station"
      },
      {
        time: "10:30â€“12:30",
        title: "å¤§é˜ªåŸæ•£ç­–",
        placeName: "Osaka Castle",
        description: "æ•£æ­¥æ‹ç…§ã€‚",
        mapsQuery: "Osaka Castle"
      }
    ]
  },

  {
    dayId: "day2",
    date: "12/6ï¼ˆå…­ï¼‰",
    highlight: "16:00 Seventeen äº¬ç“·å·¨è›‹å…¥å ´ï¼",
    events: [
      {
        time: "09:00â€“10:30",
        title: "é»‘é–€å¸‚å ´",
        placeName: "Kuromon Ichiba Market",
        description: "åƒæµ·é®®ã€é®ªé­šã€ä¸²ç‰©ã€‚",
        mapsQuery: "Kuromon Ichiba Market"
      },
      {
        time: "13:30â€“15:30",
        title: "æ–°ä¸–ç•Œé€šå¤©é–£",
        placeName: "Tsutenkaku Tower",
        description: "ä¸²ç‚¸ã€Usagiyaã€‚",
        mapsQuery: "Tsutenkaku Tower"
      },
      {
        time: "16:00â€“21:00",
        title: "Seventeen äº¬ç“·å·¨è›‹",
        placeName: "Kyocera Dome Osaka",
        description: "å…¥å ´ 16:00ï¼Œ21:00 çµæŸã€‚",
        mapsQuery: "Kyocera Dome Osaka"
      }
    ]
  }
];

/* ---------------------------------------------------------
   æ¸²æŸ“è¡Œç¨‹é ç±¤
--------------------------------------------------------- */
function renderDayChips() {
  const wrap = document.getElementById("day-switcher");
  wrap.innerHTML = "";

  itinerary.forEach((d, i) => {
    const chip = document.createElement("button");
    chip.className = "day-chip";
    chip.textContent = d.date;
    if (i === 0) chip.classList.add("active");

    chip.onclick = () => {
      document.querySelectorAll(".day-chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      renderDay(d.dayId);
    };

    wrap.appendChild(chip);
  });
}

function renderDay(dayId) {
  const day = itinerary.find(d => d.dayId === dayId);
  const box = document.getElementById("day-content");
  box.innerHTML = "";

  const h = document.createElement("div");
  h.className = "highlight-card";
  h.textContent = day.highlight;
  box.appendChild(h);

  day.events.forEach(ev => {
    const card = document.createElement("div");
    card.className = "event-card";
    card.innerHTML = `
      <div class="event-time">${ev.time}</div>
      <div class="event-title">${ev.title}</div>
      <div class="event-place">${ev.placeName}</div>
    `;
    card.onclick = () => openModal(ev, day.date);
    box.appendChild(card);
  });
}

/* ---------------------------------------------------------
   Modalï¼ˆå« Wikipedia åœ–ç‰‡ï¼‰
--------------------------------------------------------- */
const modalBackdrop = document.getElementById("modal-backdrop");
const modalImg = document.getElementById("modal-img");
const modalTitle = document.getElementById("modal-title");
const modalSub = document.getElementById("modal-sub");
const modalDesc = document.getElementById("modal-desc");
const modalNav = document.getElementById("modal-nav");
const modalClose = document.getElementById("modal-close");

async function openModal(ev, date) {
  modalTitle.textContent = ev.title;
  modalSub.textContent = `${date} Â· ${ev.placeName}`;
  modalDesc.textContent = ev.description;

  const img = await fetchWikipediaImage(ev.placeName);
  modalImg.src = img || "https://dummyimage.com/800x600/cccccc/000000&text=" + 
                  encodeURIComponent(ev.placeName);

  modalNav.onclick = () => {
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.mapsQuery)}`);
  };

  modalBackdrop.classList.add("show");
}

modalClose.onclick = () => modalBackdrop.classList.remove("show");
modalBackdrop.onclick = e => {
  if (e.target === modalBackdrop) modalBackdrop.classList.remove("show");
};

/* ---------------------------------------------------------
   æˆ¿è™Ÿå„²å­˜
--------------------------------------------------------- */
const roomInput = document.getElementById("room-number");
roomInput.value = localStorage.getItem("osaka_room") || "";
roomInput.oninput = () => {
  localStorage.setItem("osaka_room", roomInput.value);
};
/* ---------------------------------------------------------
   Supabase Init
--------------------------------------------------------- */
const supabase = window.supabase.createClient(
  "https://fmrkkwlmtxzeytjcllag.supabase.co",
  "sb_publishable_8MblOgh8PGTV7Xq3Eg_LNg_0RUtV7cR"
);

/* ---------------------------------------------------------
   è¨˜å¸³ï¼šè¼‰å…¥æ¸…å–®
--------------------------------------------------------- */
async function loadExpenses(){
  const { data } = await supabase
    .from("budgets")
    .select("*")
    .eq("trip_id", "osaka-2024")
    .order("created_at", { ascending: true });

  renderExpenses(data || []);
}

/* ---------------------------------------------------------
   è¨˜å¸³ï¼šæ¸²æŸ“åˆ—è¡¨ + çµç®—
--------------------------------------------------------- */
function renderExpenses(rows){
  let html = "";
  let totalJPY = 0;
  let byPayer = { ç¾Š:0, ç†™:0 };

  rows.forEach(r => {
    const jpy = Number(r.amount);
    const twd = Math.round(jpy * rateJPYtoTWD);

    totalJPY += jpy;
    byPayer[r.payer] += twd;

    html += `
      <div class="expense-item" id="exp-${r.id}">
        <div>
          ${r.payer}ï¼š${jpy} JPY â‰ˆ ${twd} TWD
          <div class="expense-note">${r.note || ""}</div>
        </div>
        <div class="menu-btn" onclick="openMenu('${r.id}', event)">â‹®</div>
      </div>
    `;
  });

  document.getElementById("expense-list").innerHTML = html;

  const totalTWD = Math.round(totalJPY * rateJPYtoTWD);
  document.getElementById("expense-total").textContent =
    `ç¸½è¨ˆï¼š${totalJPY} JPY ï¼ ${totalTWD} TWD`;

  /* --- AA çµç®—ï¼ˆæ–¹å¼ Bï¼Œä¸€å¥è©±ï¼‰ --- */
  const each = Math.round(totalTWD / 2);
  const diff = each - byPayer["ç†™"];

  let result = "";
  if (diff > 0) result = `ç†™ â†’ ç¾Šï¼š${diff} TWD`;
  else if (diff < 0) result = `ç¾Š â†’ ç†™ï¼š${-diff} TWD`;
  else result = `å®Œå…¨å¹³åˆ†ã€‚`;

  document.getElementById("settlement").textContent = result;
}

/* ---------------------------------------------------------
   è¨˜å¸³ï¼šä¸‰é»é¸å–®
--------------------------------------------------------- */
function openMenu(id, event){
  closeAllMenus();

  const panel = document.createElement("div");
  panel.className = "menu-panel show";
  panel.innerHTML = `
    <div class="menu-item" onclick="editItem('${id}')">ç·¨è¼¯</div>
    <div class="menu-item" onclick="deleteItem('${id}')">åˆªé™¤</div>
  `;

  document.body.appendChild(panel);

  const rect = event.target.getBoundingClientRect();
  panel.style.left = rect.left - 90 + "px";
  panel.style.top = rect.bottom + "px";
}

function closeAllMenus(){
  document.querySelectorAll(".menu-panel").forEach(p => p.remove());
}

document.body.onclick = (e) => {
  if (!e.target.classList.contains("menu-btn")) closeAllMenus();
};

/* ---------------------------------------------------------
   è¨˜å¸³ï¼šåˆªé™¤
--------------------------------------------------------- */
async function deleteItem(id){
  await supabase.from("budgets").delete().eq("id", id);
  closeAllMenus();
  loadExpenses();
}

/* ---------------------------------------------------------
   è¨˜å¸³ï¼šç·¨è¼¯
--------------------------------------------------------- */
async function editItem(id){
  closeAllMenus();

  const newJPY = prompt("æ–°çš„é‡‘é¡ï¼ˆJPYï¼‰");
  if (!newJPY) return;

  const newNote = prompt("å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰") || null;

  await supabase.from("budgets")
    .update({ amount: newJPY, note: newNote })
    .eq("id", id);

  loadExpenses();
}

/* ---------------------------------------------------------
   è¨˜å¸³ï¼šæ–°å¢
--------------------------------------------------------- */
document.getElementById("expense-form").onsubmit = async (e)=>{
  e.preventDefault();

  const amount = Number(document.getElementById("exp-amount").value);
  const payer  = document.getElementById("exp-payer").value;
  const note   = document.getElementById("exp-note").value.trim();

  await supabase.from("budgets").insert([{
    trip_id: "osaka-2024",
    amount: amount,
    payer: payer,
    note: note || null
  }]);

  document.getElementById("exp-amount").value = "";
  document.getElementById("exp-note").value = "";

  loadExpenses();
};

/* ---------------------------------------------------------
   Tab åˆ‡æ›
--------------------------------------------------------- */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    const tab = btn.dataset.tab;
    document.querySelectorAll(".tab-content").forEach(t=>{
      t.classList.remove("active");
    });
    document.getElementById(`tab-${tab}`).classList.add("active");
  };
});

/* ---------------------------------------------------------
   Service Workerï¼ˆç›¸å°è·¯å¾‘ for GitHub Pagesï¼‰
--------------------------------------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}

/* ---------------------------------------------------------
   åˆå§‹åŒ–ï¼ˆæ”¾åœ¨æœ€å¾Œé¿å… JS åŸ·è¡Œæ™‚ DOM å°šæœªç”Ÿæˆï¼‰
--------------------------------------------------------- */
async function init(){
  await fetchRate();        // è®€åŒ¯ç‡
  renderDayChips();         // æ¸²æŸ“ Day tab
  renderDay("day1");        // åˆå§‹é¡¯ç¤º Day1
  await loadExpenses();     // è¼‰å…¥è¨˜å¸³
}

window.onload = init;
</script>

</body>
</html>
