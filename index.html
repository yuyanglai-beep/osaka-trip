<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>å¤§é˜ªè¡Œç¨‹ App</title>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    header {
      padding: 14px 20px;
      background: #005BBB;
      color: white;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .tabs {
      display: flex;
      background: white;
      overflow-x: auto;
      border-bottom: 1px solid #ddd;
    }
    .tab-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 600;
      border-bottom: 3px solid transparent;
    }
    .tab-btn.active {
      color: #005BBB;
      border-bottom: 3px solid #005BBB;
    }

    .tab-content {
      display: none;
      padding: 15px;
    }
    .tab-content.active {
      display: block;
    }

    .day-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #003E7E;
    }

    .alert-box {
      padding: 12px;
      border-radius: 10px;
      background: #FFE082;
      margin-bottom: 18px;
      font-size: 15px;
      line-height: 1.4;
      border-left: 6px solid #FFB300;
    }

    .timeline {
      margin-top: 8px;
      border-left: 3px solid #005BBB;
      padding-left: 15px;
    }
    .event {
      margin-bottom: 20px;
      cursor: pointer;
      padding-left: 6px;
    }
    .event-time {
      font-weight: bold;
      color: #005BBB;
      margin-bottom: 3px;
    }
    .event-title {
      font-size: 17px;
      margin-bottom: 4px;
    }
    .event-desc {
      font-size: 14px;
      color: #666;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal-box {
      width: 90%;
      max-width: 480px;
      background: white;
      border-radius: 14px;
      overflow: hidden;
      animation: fadeInUp .25s ease;
    }
    @keyframes fadeInUp {
      from { transform: translateY(20px); opacity: 0;}
      to { transform: translateY(0); opacity: 1;}
    }

    .modal-img {
      width: 100%;
      height: 230px;
      object-fit: cover;
      background: #ddd;
    }

    .modal-body {
      padding: 15px;
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .modal-sub {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
    }
    .modal-desc {
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .modal-nav-btn {
      width: 100%;
      padding: 12px;
      background: #005BBB;
      color: white;
      text-align: center;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    /* è¨˜å¸³ */
    .expense-form {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }
    .expense-form input,
    .expense-form select {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #bbb;
      border-radius: 6px;
      flex: 1;
    }
    .expense-form button {
      background: #005BBB;
      color: white;
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .expense-item {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .expense-note {
      font-size: 14px;
      color: #666;
      margin-top: 3px;
    }
    .menu-btn {
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .menu-panel {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 6px 0;
      display: none;
      z-index: 200;
    }
    .menu-panel.show {
      display: block;
    }
    .menu-item {
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
    }
    .menu-item:hover {
      background: #f5f5f5;
    }

  </style>
</head>

<body>

<header>å¤§é˜ªè¡Œç¨‹ App</header>

<div class="tabs">
  <div class="tab-btn active" data-tab="day1">Day 1</div>
  <div class="tab-btn" data-tab="day2">Day 2</div>
  <div class="tab-btn" data-tab="day3">Day 3</div>
  <div class="tab-btn" data-tab="day4">Day 4</div>
  <div class="tab-btn" data-tab="info">è³‡è¨Š</div>
  <div class="tab-btn" data-tab="money">è¨˜å¸³</div>
</div>

<!-- Tab contents -->
<div id="tab-day1" class="tab-content active">
  <div class="day-title">12/5ï¼ˆäº”ï¼‰ Day1</div>

  <div class="alert-box">
    âœˆï¸ æŠµé”å¾Œï¼šå…ˆæ­å—æµ·ç‰¹æ€¥ â†’ å¯„è¡Œæ â†’ å¤§é˜ªåŸ â†’ å¿ƒé½‹æ©‹
  </div>

  <div class="timeline">
    <div class="event" onclick="openModal(day1[0], '12/5')">
      <div class="event-time">02:30 â†’ 06:00</div>
      <div class="event-title">GK050 æ¡ƒåœ’ T1 â†’ é—œè¥¿ T1</div>
    </div>

    <div class="event" onclick="openModal(day1[1], '12/5')">
      <div class="event-time">07:30 â†’ 09:00</div>
      <div class="event-title">å—æµ·ç‰¹æ€¥ â†’ é›£æ³¢</div>
    </div>

    <div class="event" onclick="openModal(day1[2], '12/5')">
      <div class="event-time">09:30 â†’ 10:00</div>
      <div class="event-title">å¯„è¡Œæ</div>
    </div>

    <div class="event" onclick="openModal(day1[3], '12/5')">
      <div class="event-time">10:30 â†’ 12:30</div>
      <div class="event-title">å¤§é˜ªåŸæ•£ç­–</div>
    </div>

    <div class="event" onclick="openModal(day1[4], '12/5')">
      <div class="event-time">13:30 â†’ 14:30</div>
      <div class="event-title">åˆé¤ï¼šå‰æ¬¡ç‰›èˆŒ é°»è°·åº—</div>
    </div>

    <div class="event" onclick="openModal(day1[5], '12/5')">
      <div class="event-time">15:30 â†’ 16:30</div>
      <div class="event-title">Check-in & ä¸‹åˆèŒ¶</div>
    </div>

    <div class="event" onclick="openModal(day1[6], '12/5')">
      <div class="event-time">17:30 â†’ 19:00</div>
      <div class="event-title">æ™šé¤ï¼šæ¿å‰ç‡’è‚‰ä¸€æ–—ï¼å¤§èµ·æ°´ç”¢</div>
    </div>

    <div class="event" onclick="openModal(day1[7], '12/5')">
      <div class="event-time">19:00 â†’ 21:30</div>
      <div class="event-title">é“é “å € & å¿ƒé½‹æ©‹é€›è¡—</div>
    </div>
  </div>
</div>
<!-- Day2 -->
<div id="tab-day2" class="tab-content">
  <div class="day-title">12/6ï¼ˆå…­ï¼‰ Day2</div>

  <div class="alert-box">
    ğŸ¤ Todayï¼šé»‘é–€å¸‚å ´ â†’ é€šå¤©é–£ â†’ Seventeen å¤§é˜ªäº¬ç“·å·¨è›‹
  </div>

  <div class="timeline">
    <div class="event" onclick="openModal(day2[0], '12/6')">
      <div class="event-time">09:00 â†’ 10:30</div>
      <div class="event-title">é»‘é–€å¸‚å ´</div>
    </div>

    <div class="event" onclick="openModal(day2[1], '12/6')">
      <div class="event-time">11:00 â†’ 12:30</div>
      <div class="event-title">é›£æ³¢å•†åœˆ & é›£æ³¢å…«é˜ªç¥ç¤¾</div>
    </div>

    <div class="event" onclick="openModal(day2[2], '12/6')">
      <div class="event-time">13:30 â†’ 15:30</div>
      <div class="event-title">åˆé¤ & é€šå¤©é–£ æ–°ä¸–ç•Œ</div>
    </div>

    <div class="event" onclick="openModal(day2[3], '12/6')">
      <div class="event-time">16:00 â†’ 21:00</div>
      <div class="event-title">Seventeen in å¤§é˜ªäº¬ç“·å·¨è›‹</div>
    </div>

    <div class="event" onclick="openModal(day2[4], '12/6')">
      <div class="event-time">21:30 â†’ 23:00</div>
      <div class="event-title">æ¼”å”±æœƒå¾Œæ™šé¤</div>
    </div>
  </div>
</div>

<!-- Day3 -->
<div id="tab-day3" class="tab-content">
  <div class="day-title">12/7ï¼ˆæ—¥ï¼‰ Day3</div>

  <div class="alert-box">
    â›©ï¸ å‹å°¾å¯ºåŠæ—¥éŠ â†’ æ¢…ç”°ç”œé»é€›è¡—æ—¥
  </div>

  <div class="timeline">
    <div class="event" onclick="openModal(day3[0], '12/7')">
      <div class="event-time">08:00 â†’ 09:00</div>
      <div class="event-title">æ—©åˆé¤</div>
    </div>

    <div class="event" onclick="openModal(day3[1], '12/7')">
      <div class="event-time">11:00 â†’ 14:30</div>
      <div class="event-title">å‹å°¾å¯ºåŠæ—¥éŠ</div>
    </div>

    <div class="event" onclick="openModal(day3[2], '12/7')">
      <div class="event-time">15:00 â†’ 16:30</div>
      <div class="event-title">æ¢…ç”° åˆé¤</div>
    </div>

    <div class="event" onclick="openModal(day3[3], '12/7')">
      <div class="event-time">17:00 â†’ 19:00</div>
      <div class="event-title">æ¢…ç”° ç”œé» & é€›è¡—</div>
    </div>

    <div class="event" onclick="openModal(day3[4], '12/7')">
      <div class="event-time">19:00 â†’ 21:00</div>
      <div class="event-title">æ¢…ç”° æ™šé¤</div>
    </div>
  </div>
</div>

<!-- Day4 -->
<div id="tab-day4" class="tab-content">
  <div class="day-title">12/8ï¼ˆä¸€ï¼‰ Day4</div>

  <div class="alert-box">
    âœˆï¸ å›ç¨‹æ—¥ï¼šé€€æˆ¿ â†’ å—æµ·ç‰¹æ€¥ â†’ KIX â†’ BR131
  </div>

  <div class="timeline">
    <div class="event" onclick="openModal(day4[0], '12/8')">
      <div class="event-time">08:00</div>
      <div class="event-title">é€€æˆ¿</div>
    </div>

    <div class="event" onclick="openModal(day4[1], '12/8')">
      <div class="event-time">09:00 â†’ 10:00</div>
      <div class="event-title">å—æµ·ç‰¹æ€¥ â†’ é—œè¥¿ç©ºæ¸¯</div>
    </div>

    <div class="event" onclick="openModal(day4[2], '12/8')">
      <div class="event-time">12:55 â†’ 15:05</div>
      <div class="event-title">BR131 é—œè¥¿ â†’ æ¡ƒåœ’</div>
    </div>
  </div>
</div>

<!-- è³‡è¨Š -->
<div id="tab-info" class="tab-content">
  <div class="day-title">æ—…ç¨‹è³‡è¨Š</div>

  <div class="alert-box">
    ğŸ“Œ é‡è¦æé†’ï¼š  
    é£¯åº—åœ¨ï¼šDormy Inn Premium Nanba ANNEX  
    æˆ¿è™Ÿï¼š<span id="roomNumberDisplay">å°šæœªè¨­å®š</span>
  </div>

  <p><strong>ğŸ¨ é£¯åº—ï¼š</strong>Dormy Inn Premium Nanba ANNEX</p>

  <div style="margin-top:10px;">
    <label>æˆ¿è™Ÿï¼š</label>
    <input id="roomNumberInput" type="number" placeholder="ä¾‹å¦‚ï¼š608" style="padding:8px;border:1px solid #ccc;border-radius:6px;width:140px;">
    <button onclick="saveRoomNumber()" style="padding:8px 14px;background:#005BBB;color:white;border:none;border-radius:6px;cursor:pointer;">å„²å­˜</button>
  </div>

  <hr style="margin:20px 0;">

  <p><strong>âœˆï¸ èˆªç­è³‡è¨Š</strong></p>
  <p>å»ç¨‹ï¼šGK050 æ¡ƒåœ’ â†’ å¤§é˜ªï¼ˆé»æ“Šå¯æŸ¥çœ‹ï¼‰</p>
  <a href="https://www.trip.com/webapp/flight/schedule/detail.html?isHideNavBar=YES&origin=210&useCTHybrid=1&flightNo=GK050&dcode=TPE&acode=KIX&queryDate=2025-12-05&queryTime=02:30:00&locale=zh-TW" target="_blank">
    <button style="padding:10px 14px;background:#005BBB;color:white;border:none;border-radius:6px;">æŸ¥çœ‹ GK050</button>
  </a>

  <p style="margin-top:14px;">å›ç¨‹ï¼šBR131 å¤§é˜ª â†’ æ¡ƒåœ’ï¼ˆé»æ“Šå¯æŸ¥çœ‹ï¼‰</p>
  <a href="https://www.trip.com/webapp/flight/schedule/detail.html?isHideNavBar=YES&origin=210&useCTHybrid=1&flightNo=BR131&dcode=KIX&acode=TPE&queryDate=2025-12-08&queryTime=12:55:00&locale=zh-TW" target="_blank">
    <button style="padding:10px 14px;background:#005BBB;color:white;border:none;border-radius:6px;">æŸ¥çœ‹ BR131</button>
  </a>
</div>

<!-- è¨˜å¸³ -->
<div id="tab-money" class="tab-content">
  <div class="day-title">è¨˜å¸³å°å·¥å…·</div>

  <div class="alert-box">
    ğŸ’´ è¨˜å¸³æœƒè‡ªå‹•æ›ç®—å°å¹£ï¼ˆå°ç£éŠ€è¡Œ JPY â†’ TWD åŒ¯ç‡ï¼‰
  </div>

  <form id="expense-form" class="expense-form">
    <input type="number" id="exp-amount" placeholder="é‡‘é¡ï¼ˆæ—¥å¹£ï¼‰" inputmode="numeric" required>
    <select id="exp-payer">
      <option value="ç¾Š">ç¾Š</option>
      <option value="ç†™">ç†™</option>
    </select>
    <input type="text" id="exp-note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰">
    <button type="submit">æ–°å¢</button>
  </form>

  <div id="expense-list"></div>

  <div style="margin-top:20px;font-size:17px;">
    <strong id="expense-total"></strong>
  </div>

  <div style="margin-top:8px;font-size:17px;color:#005BBB;">
    <strong>çµç®—çµæœï¼š</strong>
    <span id="settlement"></span>
  </div>
</div>
<!-- Modal -->
<div class="modal-backdrop" id="modal-backdrop" onclick="backdropClick(event)">
  <div class="modal-box">
    <img class="modal-img" id="modal-img" alt="æ™¯é»åœ–ç‰‡">
    <div class="modal-body">
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-sub" id="modal-sub"></div>
      <div class="modal-desc" id="modal-desc"></div>
      <div class="modal-nav-btn" id="modal-nav-btn">åœ°åœ–</div>
      <div style="margin-top:10px;text-align:center;">
        <button onclick="closeModal()" style="padding:8px 16px;border:none;border-radius:6px;background:#ccc;cursor:pointer;">
          é—œé–‰
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  /* -----------------------------
     è¡Œç¨‹è³‡æ–™ï¼ˆDay1 ~ Day4ï¼‰
  ----------------------------- */
  const day1 = [
    {
      title: "GK050 æ¡ƒåœ’ T1 â†’ é—œè¥¿ T1",
      placeName: "Kansai International Airport",
      desc: "ç´…çœ¼ç­æ©Ÿï¼ŒæŠµé”é—œè¥¿æ©Ÿå ´ T1ã€‚è¨˜å¾—å…ˆè£œå……æ°´åˆ†ã€ä¸Šæ´—æ‰‹é–“ã€‚",
      mapsQuery: "Kansai International Airport"
    },
    {
      title: "å—æµ·ç‰¹æ€¥ â†’ é›£æ³¢",
      placeName: "å—æµ·é›»éµ é›£æ³¢ç«™",
      desc: "å¾é—œè¥¿æ©Ÿå ´æ­å—æµ·ç‰¹æ€¥æˆ–æ‹‰çš®ç‰¹ï¼Œç›´é”é›£æ³¢ç«™ã€‚",
      mapsQuery: "Nankai Namba Station"
    },
    {
      title: "å¯„è¡Œæ",
      placeName: "Dormy Inn Premium Nanba Annex",
      desc: "å…ˆåˆ°é£¯åº—å¯„æ”¾è¡Œæï¼Œè§£æ”¾é›™æ‰‹å†é–‹å§‹ç©ã€‚",
      mapsQuery: "Dormy Inn Premium Nanba Annex"
    },
    {
      title: "å¤§é˜ªåŸæ•£ç­–",
      placeName: "Osaka Castle",
      desc: "å¤§é˜ªä»£è¡¨æ™¯é»ï¼Œé©åˆæ‹ç…§ã€æ•£æ­¥ã€çœ‹å¤©å®ˆé–£ã€‚",
      mapsQuery: "Osaka Castle"
    },
    {
      title: "åˆé¤ï¼šå‰æ¬¡ç‰›èˆŒ é°»è°·åº—",
      placeName: "å‰æ¬¡ç‰›èˆŒ é°»è°·åº—",
      desc: "ä¸»æ‰“åšåˆ‡ç‰›èˆŒï¼Œæ­é…å±±è—¥æ³¥ã€éº¥é£¯ã€‚",
      mapsQuery: "å‰æ¬¡ç‰›èˆŒ é°»è°·åº—"
    },
    {
      title: "Check-in & ä¸‹åˆèŒ¶",
      placeName: "å¿ƒé½‹æ©‹å‘¨é‚Šå’–å•¡åº—",
      desc: "Check-in å¾Œåœ¨å¿ƒé½‹æ©‹é™„è¿‘æ‰¾å¯éº—é¤…ã€è—ç“¶å’–å•¡æˆ– MooKEN æ³¡èŠ™ç•¶ä¸‹åˆèŒ¶ã€‚",
      mapsQuery: "Shinsaibashi Osaka cafes"
    },
    {
      title: "æ™šé¤ï¼šæ¿å‰ç‡’è‚‰ä¸€æ–—ï¼å¤§èµ·æ°´ç”¢",
      placeName: "æ¿å‰ç„¼è‚‰ ä¸€æ–— æ±å¿ƒé½‹æ©‹åº— æˆ– å¤§èµ·æ°´ç”¢ é“é “å €åº—",
      desc: "ç‡’è‚‰æˆ–è¿´è½‰å£½å¸äºŒé¸ä¸€ï¼Œè¦–ç•¶å¤©å¿ƒæƒ…æ±ºå®šã€‚",
      mapsQuery: "æ¿å‰ç„¼è‚‰ ä¸€æ–— æ±å¿ƒæ–æ©‹åº—"
    },
    {
      title: "é“é “å € & å¿ƒé½‹æ©‹é€›è¡—",
      placeName: "é“é “å €ãƒ»å¿ƒé½‹æ©‹å•†åº—è¡—",
      desc: "é€›è—¥å¦ã€æ‰­è›‹ã€ç« é­šç‡’ã€è·‘è·‘äººæ‹›ç‰Œã€ç¾åœ‹æ‘ä¸€å¸¶ã€‚",
      mapsQuery: "Dotonbori Shinsaibashi"
    }
  ];

  const day2 = [
    {
      title: "é»‘é–€å¸‚å ´",
      placeName: "é»’é–€å¸‚å ´",
      desc: "åƒé®ªé­šã€èŸ¹è…³ã€å°åƒã€é—œæ±ç…®ç­‰æµ·é®®èˆ‡ç†Ÿé£Ÿã€‚",
      mapsQuery: "Kuromon Ichiba Market"
    },
    {
      title: "é›£æ³¢å•†åœˆ & é›£æ³¢å…«é˜ªç¥ç¤¾",
      placeName: "é›£æ³¢å…«é˜ªç¥ç¤¾",
      desc: "é€›é›£æ³¢CITYã€ç™¾è²¨ï¼Œå†å»çœ‹è¶…å·¨å¤§çš„ç…å­é ­ç¥ç¤¾ã€‚",
      mapsQuery: "Namba Yasaka Shrine"
    },
    {
      title: "åˆé¤ & é€šå¤©é–£ æ–°ä¸–ç•Œ",
      placeName: "æ–°ä¸–ç•Œæœ¬é€šå•†åº—è¡—",
      desc: "é€›é€šå¤©é–£å‘¨é‚Šã€åƒé”æ‘©ä¸²ç‚¸æˆ– Usagiya ç”œé»ã€‚",
      mapsQuery: "Shinsekai Tsutenkaku"
    },
    {
      title: "Seventeen in å¤§é˜ªäº¬ç“·å·¨è›‹",
      placeName: "äº¬ç“·å·¨è›‹å¤§é˜ª",
      desc: "16:00 é–‹å§‹å…¥å ´ï¼Œè¨˜å¾—å¸¶ç¥¨ã€æ¯›å·¾ã€æ‡‰æ´ç‰©ã€‚",
      mapsQuery: "Kyocera Dome Osaka"
    },
    {
      title: "æ¼”å”±æœƒå¾Œæ™šé¤",
      placeName: "é›£æ³¢ä¸€å¸¶",
      desc: "å›åˆ°é›£æ³¢å¾Œåƒä¸€è˜­æ‹‰éºµã€ä¸²ç‡’æˆ–ç°¡å–®å®µå¤œã€‚",
      mapsQuery: "Ichiran Namba"
    }
  ];

  const day3 = [
    {
      title: "æ—©åˆé¤",
      placeName: "å¿ƒé½‹æ©‹æˆ–é™„è¿‘å’–å•¡å»³",
      desc: "å¯ä»¥é¸å®¢ç¾å¤šã€HARBS æˆ–é£¯åº—é™„è¿‘æ—©é¤åº—ã€‚",
      mapsQuery: "Komeda Shinsaibashi"
    },
    {
      title: "å‹å°¾å¯ºåŠæ—¥éŠ",
      placeName: "å‹å°¾å¯º",
      desc: "æ­å¾¡å ‚ç­‹ç·šåˆ°ç®•é¢è±é‡ï¼Œè½‰å·´å£«å‰å¾€ã€‚è²·é”æ‘©ç±¤ã€è“‹ç« ã€æ‹ç…§ã€‚",
      mapsQuery: "Katsuo-ji Temple"
    },
    {
      title: "æ¢…ç”° åˆé¤",
      placeName: "æ¢…ç”°è»Šç«™å‘¨é‚Š",
      desc: "å¯ä»¥åƒ new babe ç‚¸è±¬æ’æˆ–è»Šç«™å‘¨é‚Šé¤å»³ã€‚",
      mapsQuery: "Umeda Osaka"
    },
    {
      title: "æ¢…ç”° ç”œé» & é€›è¡—",
      placeName: "LUCUA / HEP FIVE / å¤§ä¸¸æ¢…ç”°",
      desc: "é€›ç™¾è²¨ã€è²·å‰ä¼Šå¡å“‡å‘¨é‚Šã€åƒ HARBS æˆ–åƒå±¤é…¥ã€‚",
      mapsQuery: "LUCUA Osaka"
    },
    {
      title: "æ¢…ç”° æ™šé¤",
      placeName: "æ¢…ç”°ä¸€å¸¶",
      desc: "å¯è€ƒæ…®ç‚¸ç‰›å…ƒæ‘æˆ–å…¶ä»–å±…é…’å±‹ã€ç‡’è‚‰åº—ã€‚",
      mapsQuery: "Umeda dinner Osaka"
    }
  ];

  const day4 = [
    {
      title: "é€€æˆ¿",
      placeName: "Dormy Inn Premium Nanba ANNEX",
      desc: "æœ€æ™š 08:00 é€€æˆ¿ï¼Œç¢ºèªè¡Œæèˆ‡é‡è¦ç‰©å“ã€‚",
      mapsQuery: "Dormy Inn Premium Nanba Annex"
    },
    {
      title: "å—æµ·ç‰¹æ€¥ â†’ é—œè¥¿ç©ºæ¸¯",
      placeName: "å—æµ·é›»éµ",
      desc: "å¾é›£æ³¢æ­å—æµ·ç‰¹æ€¥å‰å¾€é—œè¥¿æ©Ÿå ´ï¼Œé ç•™è¶³å¤ æ™‚é–“ã€‚",
      mapsQuery: "Nankai Namba Station"
    },
    {
      title: "BR131 é—œè¥¿ â†’ æ¡ƒåœ’",
      placeName: "é—œè¥¿åœ‹éš›æ©Ÿå ´ T1",
      desc: "æ­ä¹˜ BR131 å›æ¡ƒåœ’ï¼ŒçµæŸå››å¤©ä¸‰å¤œæ—…ç¨‹ã€‚",
      mapsQuery: "Kansai International Airport"
    }
  ];

  /* -----------------------------
     æœ¬åœ°åœ–ç‰‡ imageMapï¼ˆ21 å¼µï¼‰
     æª”æ¡ˆè«‹æ”¾åœ¨ ./images/ åº•ä¸‹
  ----------------------------- */
  const imageMap = {
    // Day1
    "GK050 æ¡ƒåœ’ T1 â†’ é—œè¥¿ T1": "kansai_airport.jpg",
    "å—æµ·ç‰¹æ€¥ â†’ é›£æ³¢": "nankai_namba_station.jpg",
    "å¯„è¡Œæ": "hotel_lobby.jpg",
    "å¤§é˜ªåŸæ•£ç­–": "osaka_castle.jpg",
    "åˆé¤ï¼šå‰æ¬¡ç‰›èˆŒ é°»è°·åº—": "kittsugi_beef_tongue.jpg",
    "Check-in & ä¸‹åˆèŒ¶": "brunch_generic.jpg",
    "æ™šé¤ï¼šæ¿å‰ç‡’è‚‰ä¸€æ–—ï¼å¤§èµ·æ°´ç”¢": "ittou_yakiniku.jpg",
    "é“é “å € & å¿ƒé½‹æ©‹é€›è¡—": "shinsaibashi_area.jpg",

    // Day2
    "é»‘é–€å¸‚å ´": "kuromon_market.jpg",
    "é›£æ³¢å•†åœˆ & é›£æ³¢å…«é˜ªç¥ç¤¾": "namba_yasaka.jpg",
    "åˆé¤ & é€šå¤©é–£ æ–°ä¸–ç•Œ": "shinsekai_kushikatsu.jpg",
    "Seventeen in å¤§é˜ªäº¬ç“·å·¨è›‹": "kyocera_dome.jpg",
    "æ¼”å”±æœƒå¾Œæ™šé¤": "after_concert_dinner.jpg",

    // Day3
    "æ—©åˆé¤": "harbs_umeda.jpg",
    "å‹å°¾å¯ºåŠæ—¥éŠ": "katsuoji_temple.jpg",
    "æ¢…ç”° åˆé¤": "umeda_hep_five.jpg",
    "æ¢…ç”° ç”œé» & é€›è¡—": "umeda_lucua.jpg",
    "æ¢…ç”° æ™šé¤": "umeda_dinner.jpg",

    // Day4
    "é€€æˆ¿": "hotel_checkout.jpg",
    "å—æµ·ç‰¹æ€¥ â†’ é—œè¥¿ç©ºæ¸¯": "S__21037109_0.jpg",
    "BR131 é—œè¥¿ â†’ æ¡ƒåœ’": "daiki_sushi.jpg"
  };

  /* -----------------------------
     Modal æ‰“é–‹ / é—œé–‰
  ----------------------------- */
  const modalBackdrop = document.getElementById("modal-backdrop");
  const modalImg       = document.getElementById("modal-img");
  const modalTitle     = document.getElementById("modal-title");
  const modalSub       = document.getElementById("modal-sub");
  const modalDesc      = document.getElementById("modal-desc");
  const modalNavBtn    = document.getElementById("modal-nav-btn");

  function openModal(ev, dateStr) {
    modalTitle.textContent = ev.title;
    modalSub.textContent   = `${dateStr} Â· ${ev.placeName}`;
    modalDesc.textContent  = ev.desc;

    // å„ªå…ˆä½¿ç”¨æœ¬åœ°åœ–ç‰‡
    const fileName = imageMap[ev.title];
    if (fileName) {
      modalImg.src = `./images/${fileName}`;
    } else {
      // æ²’æœ‰å°æ‡‰åœ–ç‰‡å°±çµ¦ä¸€å€‹ç°åº•æ–‡å­—åœ–
      modalImg.src = "https://dummyimage.com/800x600/cccccc/000000&text=" + encodeURIComponent(ev.placeName);
    }

    modalNavBtn.onclick = () => {
      window.open(
        `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.mapsQuery)}`,
        "_blank"
      );
    };

    modalBackdrop.classList.add("show");
  }

  function closeModal() {
    modalBackdrop.classList.remove("show");
  }

  function backdropClick(e) {
    if (e.target === modalBackdrop) {
      closeModal();
    }
  }

  /* -----------------------------
     æˆ¿è™Ÿå„²å­˜ï¼ˆlocalStorageï¼‰
  ----------------------------- */
  function saveRoomNumber() {
    const input = document.getElementById("roomNumberInput");
    const display = document.getElementById("roomNumberDisplay");
    const value = input.value.trim();

    if (!value) {
      alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");
      return;
    }
    localStorage.setItem("osaka_room_number", value);
    display.textContent = value;
  }

  function loadRoomNumber() {
    const display = document.getElementById("roomNumberDisplay");
    const input   = document.getElementById("roomNumberInput");
    const saved   = localStorage.getItem("osaka_room_number");
    if (saved) {
      display.textContent = saved;
      input.value = saved;
    }
  }

  /* -----------------------------
     Tab åˆ‡æ›
  ----------------------------- */
  const tabButtons  = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-tab");
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      tabContents.forEach(c => c.classList.remove("active"));
      document.getElementById(`tab-${target}`).classList.add("active");
    });
  });

  /* -----------------------------
     å°éŠ€åŒ¯ç‡æŠ“å–
  ----------------------------- */
  let rateJPYtoTWD = 0;

  async function fetchRate() {
    try {
      const res  = await fetch("https://rate.bot.com.tw/xrt?Lang=zh-TW");
      const html = await res.text();
      const doc  = new DOMParser().parseFromString(html, "text/html");
      const rows = doc.querySelectorAll("table tbody tr");

      rows.forEach(tr => {
        if (tr.innerText.includes("JPY")) {
          const tds = tr.querySelectorAll("td");
          const sell = parseFloat(tds[5].innerText);
          if (!isNaN(sell)) {
            rateJPYtoTWD = sell;
          }
        }
      });
      console.log("åŒ¯ç‡è®€å–æˆåŠŸï¼š", rateJPYtoTWD);
    } catch (err) {
      console.error("åŒ¯ç‡è®€å–å¤±æ•—ï¼Œæ”¹ç”¨é è¨­0.2ï¼š", err);
      rateJPYtoTWD = 0.2;
    }
  }

  /* -----------------------------
     Supabase åˆå§‹åŒ–
  ----------------------------- */
  const supabaseClient = window.supabase.createClient(
    "https://fmrkkwlmtxzeytjcllag.supabase.co",
    "sb_publishable_8MblOgh8PGTV7Xq3Eg_LNg_0RUtV7cR"
  );

  /* -----------------------------
     è¨˜å¸³ï¼šè®€å–è³‡æ–™
  ----------------------------- */
  async function loadExpenses() {
    const { data, error } = await supabaseClient
      .from("budgets")
      .select("*")
      .eq("trip_id", "osaka-2025")
      .order("created_at", { ascending: true });

    if (error) {
      console.error("è®€å–è¨˜å¸³å¤±æ•—", error);
      return;
    }

    renderExpenses(data || []);
  }

  function renderExpenses(rows) {
    const listEl   = document.getElementById("expense-list");
    const totalEl  = document.getElementById("expense-total");
    const settleEl = document.getElementById("settlement");

    listEl.innerHTML = "";

    let totalJPY = 0;
    let byPayer = { "ç¾Š": 0, "ç†™": 0 };

    rows.forEach(row => {
      const jpy = Number(row.amount) || 0;
      totalJPY += jpy;

      const twd = rateJPYtoTWD ? Math.round(jpy * rateJPYtoTWD) : 0;
      if (row.payer && byPayer[row.payer] !== undefined) {
        byPayer[row.payer] += twd;
      }

      const wrapper = document.createElement("div");
      wrapper.className = "expense-item";
      wrapper.id = `exp-${row.id}`;
      wrapper.innerHTML = `
        <div>
          <div><strong>${row.payer}</strong> æ”¯ä»˜ ${jpy} JPY â‰ˆ ${twd} TWD</div>
          <div class="expense-note">${row.note || ""}</div>
        </div>
        <div class="menu-btn" onclick="openMenu('${row.id}', event)">â‹®</div>
      `;
      listEl.appendChild(wrapper);
    });

    const totalTWD = rateJPYtoTWD ? Math.round(totalJPY * rateJPYtoTWD) : 0;
    totalEl.textContent = `ç¸½è¨ˆï¼š${totalJPY} JPYï¼ˆç´„ ${totalTWD} TWDï¼‰`;

    // AA çµç®—ï¼ˆæ–¹å¼ï¼šçœ‹å„è‡ªå·²ä»˜é‡‘é¡ï¼Œç®—èª°è¦çµ¦èª°ï¼‰
    const each = Math.round(totalTWD / 2);
    const paySheep = byPayer["ç¾Š"];
    const payXi    = byPayer["ç†™"];
    // æˆ‘å€‘å‡è¨­ target æ˜¯ã€Œå…©äººæœ€å¾Œæ‡‰è©²å„å‡º eachã€
    const diff = payXi - each; // >0 è¡¨ç¤ºç†™å¤šä»˜ï¼Œè¦æ”¶éŒ¢

    let text = "";
    if (totalTWD === 0) {
      text = "ç›®å‰é‚„æ²’æœ‰è¨˜å¸³è³‡æ–™ã€‚";
    } else if (diff > 0) {
      // ç†™å¤šä»˜
      text = `ç¾Š â†’ ç†™ï¼š${diff} TWD`;
    } else if (diff < 0) {
      // ç¾Šå¤šä»˜
      text = `ç†™ â†’ ç¾Šï¼š${-diff} TWD`;
    } else {
      text = "å®Œå…¨å¹³åˆ†ï¼Œèª°ä¹Ÿä¸ç”¨è£œã€‚";
    }
    settleEl.textContent = text;
  }

  /* -----------------------------
     è¨˜å¸³ï¼šä¸‰é»é¸å–®ï¼ˆç·¨è¼¯ / åˆªé™¤ï¼‰
  ----------------------------- */
  let currentMenu = null;

  function openMenu(id, event) {
    closeMenu();

    const panel = document.createElement("div");
    panel.className = "menu-panel show";
    panel.innerHTML = `
      <div class="menu-item" onclick="editExpense('${id}')">ç·¨è¼¯</div>
      <div class="menu-item" onclick="deleteExpense('${id}')">åˆªé™¤</div>
    `;

    document.body.appendChild(panel);
    currentMenu = panel;

    const rect = event.target.getBoundingClientRect();
    panel.style.left = (rect.right - 120) + "px";
    panel.style.top  = (rect.bottom + 4) + "px";
  }

  function closeMenu() {
    if (currentMenu) {
      currentMenu.remove();
      currentMenu = null;
    }
  }

  document.body.addEventListener("click", (e) => {
    if (!e.target.classList.contains("menu-btn")) {
      closeMenu();
    }
  });

  async function deleteExpense(id) {
    const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ");
    if (!ok) return;

    const { error } = await supabaseClient
      .from("budgets")
      .delete()
      .eq("id", id);

    if (error) {
      alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      console.error(error);
      return;
    }
    closeMenu();
    loadExpenses();
  }

  async function editExpense(id) {
    closeMenu();

    const newAmount = prompt("è«‹è¼¸å…¥æ–°çš„é‡‘é¡ï¼ˆæ—¥å¹£ï¼‰ï¼š");
    if (newAmount === null) return;
    const amt = Number(newAmount);
    if (isNaN(amt) || amt <= 0) {
      alert("é‡‘é¡å¿…é ˆæ˜¯æ­£æ•¸");
      return;
    }
    const newNote = prompt("è«‹è¼¸å…¥å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰ï¼š") || "";

    const { error } = await supabaseClient
      .from("budgets")
      .update({ amount: amt, note: newNote })
      .eq("id", id);

    if (error) {
      alert("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      console.error(error);
      return;
    }
    loadExpenses();
  }

  /* -----------------------------
     è¨˜å¸³ï¼šæ–°å¢
  ----------------------------- */
  const expenseForm = document.getElementById("expense-form");
  expenseForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const amtInput  = document.getElementById("exp-amount");
    const payerSel  = document.getElementById("exp-payer");
    const noteInput = document.getElementById("exp-note");

    const amount = Number(amtInput.value);
    if (isNaN(amount) || amount <= 0) {
      alert("é‡‘é¡å¿…é ˆæ˜¯æ­£æ•¸");
      return;
    }
    const payer = payerSel.value;
    const note  = noteInput.value.trim();

    const { error } = await supabaseClient
      .from("budgets")
      .insert([{
        trip_id: "osaka-2025",
        amount: amount,
        payer: payer,
        note: note || null
      }]);

    if (error) {
      alert("æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      console.error(error);
      return;
    }

    amtInput.value  = "";
    noteInput.value = "";
    loadExpenses();
  });

  /* -----------------------------
     Service Workerï¼ˆPWAï¼‰
  ----------------------------- */
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js")
      .then(() => console.log("Service Worker è¨»å†ŠæˆåŠŸ"))
      .catch(err => console.error("Service Worker è¨»å†Šå¤±æ•—", err));
  }

  /* -----------------------------
     åˆå§‹åŒ–
  ----------------------------- */
  async function init() {
    loadRoomNumber();
    await fetchRate();
    await loadExpenses();
  }

  window.addEventListener("load", init);
</script>

</body>
</html>
