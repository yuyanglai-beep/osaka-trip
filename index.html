<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>Osaka Trip ğŸ± - v11.5-milktea</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2ï¼ˆå…±åŒè¨˜å¸³ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- PWA theme color -->
  <meta name="theme-color" content="#c8a889">

  <!-- Service Worker è¨»å†Šï¼ˆè®“Appå¯å®‰è£/é›¢ç·šï¼‰ -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>

  <style>
:root{
  /* å¥¶èŒ¶èª¿æ ¡ç‰ˆ palette */
  --bg:#EFE9E2;
  --card:#FFFFFF;
  --ink:#3E332A;
  --muted:#867969;

  --line:#E5DBCF;

  --accent:#C8A889;        /* main milk-tea */
  --accent-soft:#F4ECE4;   /* soft milk-tea */
  --accent-dark:#A28362;   /* deeper header */

  --important:#C7D6C1;     /* genmaicha green for reminders edge */
  --important-soft:#F3F6F1;
  --important-text:#3A4E3E;
}

body{
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  -webkit-tap-highlight-color:transparent;
}
body::before{
  content:"";
  position:fixed; inset:0;
  pointer-events:none;
  background:
    radial-gradient(900px 420px at 0% -10%, rgba(200,168,137,0.14), transparent 60%),
    radial-gradient(700px 360px at 100% 0%, rgba(168,132,99,0.10), transparent 60%);
  z-index:-1;
}

/* -------- Topbarï¼ˆå‡ç´šç‰ˆï¼‰ -------- */
.topbar{
  position:sticky; top:0; z-index:35;
  background:linear-gradient(180deg, rgba(200,168,137,0.98), rgba(162,131,98,0.98));
  color:white;
  border-bottom:1px solid rgba(255,255,255,0.26);
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  backdrop-filter: blur(18px);
}
.topbar-inner{
  max-width:440px; margin:0 auto;
  padding:10px 12px 8px;
}
.title{
  font-weight:900;
  font-size:21px;
  letter-spacing:.48px;
}
.subtitle{
  color:rgba(255,255,255,0.9);
  font-size:12px;
  margin-top:3px;
}
.seg{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.chip{
  background:rgba(255,255,255,0.15);
  border:1px solid rgba(255,255,255,0.45);
  border-radius:999px;
  padding:6px 12px;
  font-size:12px;
  font-weight:900;
  color:white;
  backdrop-filter: blur(10px);
  box-shadow:0 2px 6px rgba(0,0,0,0.16);
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.chip.hotel{
  background:rgba(255,255,255,0.2);
}

/* -------- Layout -------- */
.phone{
  max-width:440px;
  margin:0 auto;
  min-height:100vh;
  padding:0 12px 96px;
}

/* -------- Tabbarï¼ˆåº•éƒ¨ï¼‰ -------- */
.tabbar{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:92%;
  max-width:420px;
  background:rgba(255,255,255,0.96);
  border:1px solid rgba(226,213,196,0.9);
  border-radius:18px;
  display:flex;
  padding:6px;
  gap:6px;
  box-shadow:0 18px 45px rgba(15,23,42,0.18);
  z-index:40;
  backdrop-filter: blur(20px);
}
.tabbtn{
  flex:1;
  text-align:center;
  padding:9px 0;
  font-size:12px;
  font-weight:900;
  color:var(--muted);
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.tabbtn span.icon{
  font-size:14px;
}
.tabbtn.active{
  background:var(--accent-soft);
  color:#7b5b3f;
  box-shadow:0 1px 6px rgba(0,0,0,0.08) inset;
}

/* -------- ä¸»ç•«é¢å®¹å™¨æ·¡å…¥å‹•ç•« -------- */
#main,
#tools{
  display:none;
  opacity:0;
  transform:translateY(8px);
  transition:opacity .22s ease-out, transform .22s ease-out;
}
#main.active,
#tools.active{
  display:block;
  opacity:1;
  transform:translateY(0);
}

/* -------- Day Segmented Control -------- */
.pills{
  position:sticky;
  top:58px;
  z-index:20;
  padding:10px 2px 6px;
  display:flex;
  gap:0;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.pills-inner{
  display:flex;
  gap:0;
  background:rgba(244,236,228,0.95);
  border-radius:999px;
  border:1px solid rgba(223,208,191,0.9);
  padding:3px;
  box-shadow:0 4px 12px rgba(0,0,0,0.04);
}
.pill{
  flex:1;
  background:transparent;
  border:none;
  border-radius:999px;
  padding:7px 14px;
  font-size:12px;
  font-weight:900;
  color:var(--muted);
  white-space:nowrap;
  display:flex;
  align-items:center;
  justify-content:center;
  min-width:72px;
}
.pill.active{
  background:var(--card);
  color:#7b5b3f;
  box-shadow:0 2px 8px rgba(0,0,0,0.12);
}

/* -------- Day / å¡ç‰‡ -------- */
.day{
  display:none;
  padding-top:10px;
}
.day.active{
  display:block;
  animation:dayFadeIn .22s ease-out;
}
@keyframes dayFadeIn{
  from{
    opacity:0;
    transform:translateX(8px);
  }
  to{
    opacity:1;
    transform:translateX(0);
  }
}

.dayhead{
  margin:6px 2px 10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.daytitle{
  font-weight:900;
  font-size:16px;
}
.weather{
  align-self:flex-end;
  background:var(--card);
  border:1px solid rgba(226,213,196,0.9);
  border-radius:999px;
  padding:4px 10px;
  font-size:12px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:6px;
  min-width:140px;
  justify-content:flex-end;
  box-shadow:0 1px 4px rgba(15,23,42,0.08);
}

/* ä»Šæ—¥æé†’ */
.today-imp{
  background:var(--important-soft);
  border:1px solid rgba(199,214,193,0.95);
  border-left:4px solid var(--important);
  border-radius:12px;
  padding:8px 10px;
  font-size:13px;
  font-weight:900;
  color:var(--important-text);
  display:none;
  box-shadow:0 2px 9px rgba(26,46,35,0.14);
}
.today-imp.show{
  display:block;
}

/* å¡ç‰‡æœ¬é«” */
.card{
  background:var(--card);
  border-radius:14px;
  padding:12px;
  margin-bottom:9px;
  position:relative;
  border:1px solid rgba(0,0,0,0.04);
  box-shadow:0 1px 6px rgba(15,23,42,0.12);
}
.card.important{
  border-left:4px solid var(--important);
  background:linear-gradient(180deg, #FFFFFF, var(--important-soft));
}
.important-badge{
  font-size:11px;
  font-weight:900;
  color:var(--important-text);
  background:var(--important-soft);
  border:1px solid rgba(195,209,190,0.9);
  border-radius:8px;
  padding:2px 6px;
}
.time{
  font-weight:900;
  font-size:12px;
  letter-spacing:.3px;
  color:#7b5b3f;
}
.row{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:8px;
  margin-top:4px;
}
.h3{
  font-weight:900;
  font-size:15px;
  line-height:1.35;
}
.card-actions{
  margin-top:6px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.note{
  font-size:13px;
  color:var(--ink);
  white-space:pre-line;
  margin-top:6px;
  line-height:1.6;
}

/* æŒ‰éˆ• */
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,0.96);
  border-radius:10px;
  padding:6px 8px;
  font-size:12px;
  font-weight:900;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.btn.map{
  color:#7b5b3f;
  border-color:#e9d7c3;
  background:#f7efe6;
}
.btn.nav{
  color:#0b7a41;
  border-color:#bbf7d0;
  background:#ecfdf5;
}
.btn.search{
  color:#7c3aed;
  border-color:#ddd6fe;
  background:#f5f3ff;
}

/* å­é …ç›® */
.sub{
  margin-top:8px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.subitem{
  background:rgba(255,255,255,0.95);
  border:1px dashed var(--line);
  border-radius:10px;
  padding:8px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:4px;
  font-size:13px;
  font-weight:800;
}
.subitem-actions{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}

/* å·¥å…·å€ */
.tools{
  padding-top:8px;
}
.tools-card{
  background:var(--card);
  border:1px solid rgba(0,0,0,0.04);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
  box-shadow:0 1px 6px rgba(15,23,42,0.12);
}
.tools-title{
  font-weight:900;
  font-size:14px;
  margin-bottom:6px;
}

/* Input åŸºç¤æ¨£å¼ */
input, select{
  width:100%;
  border:1px solid var(--line);
  border-radius:10px;
  padding:8px 10px;
  font-size:13px;
  background:white;
}

/* è¨˜å¸³å¡ç‰‡ï¼ˆæŠ˜ç–Šç‰ˆï¼‰ */
.budget-card{
  border-radius:14px;
  border:1px solid rgba(0,0,0,0.04);
  background:var(--card);
  box-shadow:0 1px 6px rgba(15,23,42,0.12);
  padding:8px 10px;
  margin-top:6px;
}
.budget-header{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  background:transparent;
  border:none;
  padding:4px 0;
}
.budget-title{
  font-size:13px;
  font-weight:800;
  text-align:left;
}
.budget-meta{
  font-size:12px;
  color:var(--muted);
  text-align:right;
}
.budget-body{
  margin-top:6px;
  display:none;
}
.budget-card.open .budget-body{
  display:block;
}
.budget-row-fields{
  display:grid;
  grid-template-columns: 1.4fr 1fr 1fr;
  gap:6px;
}
.budget-actions{
  margin-top:6px;
  display:flex;
  gap:6px;
}
.budget-total{
  font-weight:900;
  color:#7b5b3f;
  margin-top:8px;
  font-size:14px;
}
.muted{
  color:var(--muted);
  font-size:12px;
}

/* Modalï¼ˆåº•éƒ¨æ»‘å‡º sheetï¼‰ */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.35);
  display:none;
  align-items:flex-end;
  justify-content:center;
  padding:0 12px 16px;
  z-index:60;
  backdrop-filter: blur(14px);
}
.modal-backdrop.show{
  display:flex;
}
.modal-sheet{
  width:100%;
  max-width:420px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  overflow:hidden;
  border:1px solid var(--line);
  box-shadow:0 18px 50px rgba(0,0,0,0.28);
  transform:translateY(100%);
  transition:transform .25s ease-out;
}
.modal-backdrop.show .modal-sheet{
  transform:translateY(0);
}
.modal-sheet.full{
  height:92vh;
}
.modal-handle{
  width:46px;
  height:4px;
  border-radius:999px;
  background:rgba(148,136,121,0.4);
  margin:8px auto 4px;
}
.modal-head{
  padding:8px 12px;
  background:var(--accent-dark);
  color:white;
  font-weight:900;
  font-size:13px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.modal-close{
  background:white;
  color:var(--accent-dark);
  width:26px;
  height:26px;
  border-radius:999px;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
}
.modal-map{
  height:calc(92vh - 56px);
  background:#0b1220;
}
.modal-body{
  padding:12px;
}

/* Modal loading */
.modal-loading{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:13px;
  font-weight:900;
  color:#f9fafb;
  background:radial-gradient(circle at 20% 20%, rgba(248,250,252,0.22), rgba(15,23,42,1));
}

/* å° icon æŒ‰éˆ• */
.icon-rotate{
  transition:transform 0.18s ease-out;
}
.budget-card.open .icon-rotate{
  transform:rotate(90deg);
}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="title">Osaka Trip ğŸ±</div>
      <div class="subtitle">æ—¥æœ¬å¤§é˜ª ï½œå››å¤©ä¸‰å¤œğŸ‡¯ğŸ‡µ 12/5â€“12/8</div>
      <div class="seg">
        <button class="chip" onclick="openTripModal('GK050','https://tw.trip.com/actualtime/detail?flightNo=GK050&departCity=TPE&arriveCity=KIX&date=2025-12-05&locale=zh-TW&curr=TWD')">
          âœˆï¸ <span>GK050</span>
        </button>
        <button class="chip" onclick="openTripModal('BR131','https://tw.trip.com/actualtime/detail?flightNo=BR131&departCity=KIX&arriveCity=TPE&date=2025-12-08&locale=zh-TW&curr=TWD')">
          âœˆï¸ <span>BR131</span>
        </button>
        <button class="chip hotel" onclick="openHotelModal()">
          ğŸ¨ <span>Dormy inn PREMIUM Nanba ANNEX</span>
        </button>
      </div>
    </div>
  </div>

  <div class="phone">
    <main id="main"></main>
    <section id="tools" class="tools"></section>

    <nav class="tabbar">
      <button id="tab-itin" class="tabbtn active" onclick="showTab('itin')">
        <span class="icon">ğŸ—ºï¸</span><span>è¡Œç¨‹</span>
      </button>
      <button id="tab-tools" class="tabbtn" onclick="showTab('tools')">
        <span class="icon">ğŸ’°</span><span>è¨˜å¸³</span>
      </button>
    </nav>
  </div>

  <!-- Map Modal -->
  <div id="mapModal" class="modal-backdrop">
    <div class="modal-sheet full" id="mapSheet">
      <div class="modal-handle"></div>
      <div class="modal-head">
        <div id="mapModalTitle">åœ°åœ–</div>
        <button class="modal-close" onclick="closeMapModal()">âœ•</button>
      </div>
      <div id="mapModalMap" class="modal-map"></div>
    </div>
  </div>

  <!-- Trip Modal -->
  <div id="tripModal" class="modal-backdrop">
    <div class="modal-sheet full" id="tripSheet">
      <div class="modal-handle"></div>
      <div class="modal-head">
        <div id="tripModalTitle">èˆªç­è³‡è¨Š</div>
        <button class="modal-close" onclick="closeTripModal()">âœ•</button>
      </div>
      <div id="tripModalBody" class="modal-map"></div>
    </div>
  </div>

  <!-- Hotel Modal -->
  <div id="hotelModal" class="modal-backdrop">
    <div class="modal-sheet" id="hotelSheet">
      <div class="modal-handle"></div>
      <div class="modal-head">
        <div>ä½å®¿è³‡è¨Š</div>
        <button class="modal-close" onclick="closeHotelModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="font-extrabold text-slate-900">Dormy inn PREMIUM Nanba ANNEX</div>
        <div class="mt-2 flex gap-2">
          <button class="btn map" onclick="openMapModal('Dormy inn PREMIUM Nanba ANNEX','https://www.google.com/maps/embed/v1/place?key=AIzaSyA6UWf1nf2j8aYSPlYytWaU4cRQbnPdFuY&q=Dormy%20inn%20PREMIUM%20Nanba%20ANNEX')">åœ°åœ–</button>
          <a class="btn nav" href="https://www.google.com/maps/dir/?api=1&destination=Dormy%20inn%20PREMIUM%20Nanba%20ANNEX&travelmode=driving" target="_blank" rel="noopener">å°èˆª</a>
        </div>

        <div class="mt-4 font-extrabold text-sm">æˆ¿é–“è™Ÿç¢¼</div>
        <input id="roomNumberInput" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š1203" class="mt-2">
        <div class="muted mt-1">æœƒè‡ªå‹•å„²å­˜åœ¨æ‰‹æ©Ÿï¼Œä¸æ€•å¿˜è¨˜ã€‚</div>
      </div>
    </div>
  </div>

<script>
/* ---------------- PWAï¼šè¨»å†Š Service Worker ---------------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

/* ---------------- Supabase è¨­å®šï¼ˆå…±åŒè¨˜å¸³ç”¨ï¼‰ ---------------- */
const SUPABASE_URL = "https://fmrkkwlmtxzeytjcllag.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtcmtrd2xtdHh6ZXl0amNsbGFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTIxNDYsImV4cCI6MjA3OTcyODE0Nn0.ulHd0NhuLAAWHuyT2J4lDDRWkq969W9omGRATbGevP8";

/* âœ… æ­£ç¢ºåˆå§‹åŒ–ï¼ˆä¸å†ç”¨ window.supabase åˆ¤æ–·ï¼‰ */
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// é€™å€‹è¡Œç¨‹çš„ IDï¼ˆçµ¦å¤šå€‹è¡Œç¨‹å…±ç”¨æ™‚å€åˆ†ç”¨ï¼‰
const TRIP_ID = "osaka-v11-milktea";

/* ---------------- è¡Œç¨‹ DATA ---------------- */
const DATA = {/* ä½ çš„ DATA åŸæ¨£ä¿ç•™ï¼Œç‚ºäº†é•·åº¦å°±ä¸å±•é–‹äº†ï¼Œå¯ç›´æ¥æ²¿ç”¨åŸæœ¬ JSON */};
</script>

<!-- ğŸ‘† é€™è£¡è«‹æŠŠåŸæœ¬é‚£æ•´æ®µ DATA JSON è²¼å›ä¾†ï¼ˆå®Œå…¨ç…§ä½ çš„ï¼‰ -->

<script>
/* ---------- Tabsï¼šçµ²æ»‘åˆ‡æ› ---------- */
function showTab(tab){
  const showItin = (tab === "itin");
  const itinBtn = document.getElementById("tab-itin");
  const toolsBtn = document.getElementById("tab-tools");
  const main = document.getElementById("main");
  const tools = document.getElementById("tools");

  itinBtn.classList.toggle("active", showItin);
  toolsBtn.classList.toggle("active", !showItin);
  main.classList.toggle("active", showItin);
  tools.classList.toggle("active", !showItin);
}

/* ---------- Itinerary (time order) ---------- */
function toMinutes(t){
  if(!t) return 0;
  const parts = t.split(":");
  const h = Number(parts[0]||0), m = Number(parts[1]||0);
  return h*60 + m;
}

function renderSubitem(si){
  const mapBtn = si.map_embed ? `<button class="btn map" onclick="event.stopPropagation(); openMapModal('${escapeJs(si.text||'åœ°åœ–')}','${escapeJs(si.map_embed)}')">åœ°åœ–</button>` : "";
  const navBtn = si.nav_external ? `<a class="btn nav" href="${si.nav_external}" target="_blank" rel="noopener">å°èˆª</a>` : "";
  const searchBtn = si.map_query ? `<a class="btn search" href="https://www.google.com/search?q=${encodeURIComponent(si.map_query+' æ”»ç•¥')}" target="_blank" rel="noopener">æ”»ç•¥</a>` : "";
  const actions = (mapBtn || navBtn || searchBtn) ? `<div class="subitem-actions">${mapBtn}${navBtn}${searchBtn}</div>` : "";
  return `
    <div class="subitem">
      <div>${escapeHtml(si.text||"")}</div>
      ${actions}
    </div>`;
}

function renderEvent(ev){
  const time = ev.end ? `${ev.start}â€“${ev.end}` : (ev.start||"");
  const impBadge = ev.important ? `<span class="important-badge">Important</span>` : "";
  const mapBtn = ev.map_embed ? `<button class="btn map" onclick="event.stopPropagation(); openMapModal('${escapeJs(ev.title||'åœ°åœ–')}','${escapeJs(ev.map_embed)}')">åœ°åœ–</button>` : "";
  const navBtn = ev.nav_external ? `<a class="btn nav" href="${ev.nav_external}" target="_blank" rel="noopener">å°èˆª</a>` : "";
  const searchBtn = ev.map_query ? `<a class="btn search" href="https://www.google.com/search?q=${encodeURIComponent(ev.map_query+' æ”»ç•¥')}" target="_blank" rel="noopener">æ”»ç•¥</a>` : "";
  const actions = (mapBtn || navBtn || searchBtn) ? `<div class="card-actions">${mapBtn}${navBtn}${searchBtn}</div>` : "";
  const subHtml = (ev.subitems||[]).length ? `<div class="sub">${(ev.subitems||[]).map(renderSubitem).join("")}</div>` : "";
  return `
  <article class="card ${ev.important?'important':''}">
    <div class="time">${time} ${impBadge}</div>
    <div class="row">
      <div class="h3">${escapeHtml(ev.icon||"")} ${escapeHtml(ev.title||"")}</div>
    </div>
    ${actions}
    ${ev.note?`<div class="note">${escapeHtml(ev.note)}</div>`:""}
    ${subHtml}
  </article>`;
}

function renderDay(day, di){
  const events = (day.events||[]).slice().sort((a,b)=>toMinutes(a.start)-toMinutes(b.start));
  const imps = events.filter(e=>e.important);
  const impBox = imps.length ? `
    <div class="today-imp show" id="todayImp-${di}">
      ğŸ”¶ ä»Šæ—¥æé†’<br>
      ${imps.map(e=>`${escapeHtml(e.start||'')} â€” ${escapeHtml(e.title||'')}`).join("<br>")}
    </div>` : `<div class="today-imp" id="todayImp-${di}"></div>`;
  return `
    <section class="day" id="day-${di}">
      <div class="dayhead">
        <div class="daytitle">${escapeHtml(day.title||"")}</div>
        <div class="weather" id="weather-${di}">å¤©æ°£è®€å–ä¸­â€¦</div>
        ${impBox}
      </div>
      ${events.map(renderEvent).join("")}
    </section>
  `;
}

let currentDayIndex = 0;
const DAY_KEY = "osakaActiveDayV11";

function renderItinerary(){
  const main = document.getElementById("main");
  const savedDay = Number(localStorage.getItem(DAY_KEY));
  const startDay = (!isNaN(savedDay) && savedDay>=0 && savedDay<DATA.days.length) ? savedDay : 0;
  currentDayIndex = startDay;

  main.innerHTML = `
    <div class="pills">
      <div class="pills-inner">
        ${DATA.days.map((d,i)=>`<button class="pill ${i===startDay?'active':''}" onclick="showDay(${i})">Day${i+1}</button>`).join("")}
      </div>
    </div>
    ${DATA.days.map((d,i)=>renderDay(d,i)).join("")}
  `;
  showDay(startDay);
}

function updateTodayImportant(activeIndex){
  document.querySelectorAll(".today-imp").forEach((el,i)=>{
    if(el.classList.contains("show")){
      el.style.display = i===activeIndex ? "block" : "none";
    }
  });
}

function showDay(di){
  const prev = currentDayIndex;
  const scrollY = window.scrollY || window.pageYOffset || 0;
  localStorage.setItem(`osakaScrollDay-${prev}`, String(scrollY));

  document.querySelectorAll(".day").forEach((el,i)=>el.classList.toggle("active", i===di));
  updateTodayImportant(di);
  document.querySelectorAll(".pill").forEach((el,i)=>el.classList.toggle("active", i===di));

  currentDayIndex = di;
  localStorage.setItem(DAY_KEY, String(di));

  const saved = Number(localStorage.getItem(`osakaScrollDay-${di}`));
  const targetY = isNaN(saved) ? 0 : saved;
  window.scrollTo({top:targetY, behavior:"smooth"});
}

/* ---------- Weatherï¼ˆæº«åº¦ + é™é›¨æ©Ÿç‡ï¼›ç§»é™¤ ?. / ??ï¼‰ ---------- */
async function loadWeatherForDay(day, di){
  const box = document.getElementById("weather-"+di);
  if(!box) return;

  const city = "Osaka";
  const cacheKey = "osakaWeatherCacheV11-temp-rain";

  try{
    let cache = {};
    try{
      const raw = localStorage.getItem(cacheKey);
      cache = raw ? JSON.parse(raw) : {};
    }catch(e){
      cache = {};
    }

    const now = Date.now();
    if(cache[city] && (now - cache[city].ts) < 15*60*1000){
      const c = cache[city];
      box.textContent = "ğŸŒ¡ï¸ " + c.t + "Â°C  â˜” " + c.rain + "%";
      return;
    }

    const q = encodeURIComponent(city);
    const geo = await fetch(
      "https://nominatim.openstreetmap.org/search?format=json&q=" + q,
      { headers:{ "Accept-Language":"ja,en,zh-TW" } }
    ).then(function(r){ return r.json(); });

    if(!geo || !geo[0]) throw new Error("geo");

    const lat = geo[0].lat;
    const lon = geo[0].lon;

    const w = await fetch(
      "https://api.open-meteo.com/v1/forecast"
      + "?latitude=" + lat
      + "&longitude=" + lon
      + "&current=temperature_2m"
      + "&daily=precipitation_probability_max"
      + "&forecast_days=1"
      + "&timezone=Asia%2FTokyo"
    ).then(function(r){ return r.json(); });

    var t = "-";
    if(w && w.current && typeof w.current.temperature_2m !== "undefined"){
      t = w.current.temperature_2m;
    }

    var rain = "-";
    if(w && w.daily && w.daily.precipitation_probability_max
       && w.daily.precipitation_probability_max[0] != null){
      rain = w.daily.precipitation_probability_max[0];
    }

    box.textContent = "ğŸŒ¡ï¸ " + t + "Â°C  â˜” " + rain + "%";

    cache[city] = { ts:now, t:t, rain:rain };
    localStorage.setItem(cacheKey, JSON.stringify(cache));
  }catch(e){
    console.error(e);
    box.textContent = "å¤©æ°£æš«æ™‚è®€ä¸åˆ°";
  }
}


/* ---------- è¨˜å¸³ï¼ˆå…±åŒè¨˜å¸³ç‰ˆï¼‰ ---------- */
const FX_KEY = "osakaFxRateV9milktea";
const PAYERS = ["ç¾Š","ç†™"];
let budgetItems = [];
const budgetState = {};

function renderTools(){
  const tools = document.getElementById("tools");
  tools.innerHTML = `
    <div class="tools-card">
      <div class="tools-title">ğŸ§¾ è¨˜å¸³ / é ç®—ï¼ˆJPY â†’ TWD è‡ªå‹•çµç®—ï¼‰</div>
      <div class="muted">
        å…±åŒè¨˜å¸³ï¼šä»˜æ¬¾äººå›ºå®šã€Œç¾Šã€ç†™ã€ï¼Œè³‡æ–™æœƒåŒæ­¥åˆ°é›²ç«¯ï¼ˆSupabaseï¼‰ã€‚
      </div>

      <div class="mt-2 grid grid-cols-2 gap-2">
        <div>
          <div class="muted mb-1">JPYâ†’TWD åŒ¯ç‡</div>
          <input id="fxRateInput" type="number" step="0.001" inputmode="decimal" />
        </div>
        <div class="flex items-end">
          <button class="btn map w-full justify-center" onclick="resetBudget()">æ¸…ç©ºå…¨éƒ¨</button>
        </div>
      </div>

      <div id="budget-list" class="mt-2"></div>

      <div class="mt-2 flex gap-2">
        <button class="btn map" onclick="addBudgetRow()">æ–°å¢é …ç›®</button>
        <button class="btn nav" onclick="reloadBudget()">é‡æ–°æ•´ç†</button>
      </div>

      <div id="budget-total" class="budget-total"></div>
      <div id="budget-summary" class="mt-2 text-sm"></div>
      <div id="budget-settlement" class="mt-2 text-sm font-semibold"></div>
      <div id="budget-status" class="mt-2 text-xs text-slate-500"></div>
    </div>
  `;
  initFxRate();
  initBudget();
}

function initFxRate(){
  const fx = document.getElementById("fxRateInput");
  const saved = Number(localStorage.getItem(FX_KEY));
  fx.value = saved || 0.21;
  fx.oninput = () => {
    localStorage.setItem(FX_KEY, String(Number(fx.value||0)));
    calcSettlement();
  };
}

function setBudgetStatus(msg){
  const box = document.getElementById("budget-status");
  if(box) box.textContent = msg || "";
}

/* ---- Supabase ç›¸é—œ ---- */
async function fetchBudgetFromSupabase(){
  if(!supabaseClient){
    setBudgetStatus("âš ï¸ Supabase æœªè¨­å®šï¼Œåƒ…æœ¬æ©Ÿå¯ç”¨ã€‚");
    return [];
  }
  setBudgetStatus("é›²ç«¯è³‡æ–™è¼‰å…¥ä¸­â€¦");
  const { data, error } = await supabaseClient
    .from('budgets')
    .select('*')
    .eq('trip_id', TRIP_ID)
    .order('created_at', { ascending: true });

  if(error){
    console.error(error);
    setBudgetStatus("âš ï¸ é›²ç«¯è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚");
    return [];
  }
  setBudgetStatus("âœ… å·²èˆ‡é›²ç«¯åŒæ­¥ã€‚");
  return data || [];
}

async function insertBudgetItem(note="", amount=0, payer=PAYERS[0]){
  if(!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .insert([{ trip_id: TRIP_ID, note, amount:Number(amount)||0, payer }]);
  if(error) console.error(error);
}

async function updateBudgetItem(id, fields){
  if(!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .update(fields)
    .eq('id', id);
  if(error) console.error(error);
}

async function deleteBudgetItem(id){
  if(!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .delete()
    .eq('id', id);
  if(error) console.error(error);
}

async function clearAllBudget(){
  if(!supabaseClient) return;
  const { error } = await supabaseClient
    .from('budgets')
    .delete()
    .eq('trip_id', TRIP_ID);
  if(error) console.error(error);
}

/* ---- è¨˜å¸³æ“ä½œæµç¨‹ ---- */
async function initBudget(){
  await reloadBudget();
  setupBudgetRealtime();
}

async function reloadBudget(){
  budgetItems = await fetchBudgetFromSupabase();
  renderBudget();
  calcSettlement();
}

/* æŠ˜ç–Šå¡ç‰‡ render */
function renderBudgetItem(it){
  if(!budgetState[it.id]){
    budgetState[it.id] = { expanded:false, locked:true };
  }
  const st = budgetState[it.id];

  if((!it.note || it.note==="") && (!it.amount || Number(it.amount)===0)){
    st.expanded = true;
    st.locked = false;
  }

  const amount = Number(it.amount)||0;
  const payer = it.payer || PAYERS[0];
  const title = it.note || "ï¼ˆæœªå¡«é …ç›®ï¼‰";

  const fx = Number(localStorage.getItem(FX_KEY)||0.21);
  const isEmptyNew = (!it.note || it.note==="") && amount===0;
  const displayJPY = isEmptyNew ? "--" : amount.toLocaleString();
  const displayTWD = isEmptyNew ? "--" : ((amount||0)*fx).toFixed(0);

  const expandedClass = st.expanded ? "open" : "";
  const lockLabel = st.locked ? "å·²é–å®š" : "ç·¨è¼¯ä¸­";

  return `
    <div class="budget-card ${expandedClass}" data-id="${it.id}">
      <button class="budget-header" onclick="toggleBudgetExpand('${it.id}')">
        <div class="budget-title">
          ${escapeHtml(title)}
        </div>
        <div class="budget-meta">
          <div>${displayJPY} JPY / ${displayTWD} TWD</div>
          <div>${escapeHtml(payer)} Â· ${lockLabel}
            <span class="icon-rotate inline-block ml-1">â€º</span>
          </div>
        </div>
      </button>
      <div class="budget-body">
        <div class="budget-row-fields">
          <input
            placeholder="é …ç›®"
            value="${escapeAttr(it.note||"")}"
            ${st.locked ? "readonly" : ""}
            oninput="onBudgetDraftChange('${it.id}','note',this.value)"
          >
          <input
            placeholder="é‡‘é¡(JPY)"
            type="number"
            inputmode="decimal"
            value="${amount>0 ? amount : ''}"
            ${st.locked ? "readonly" : ""}
            oninput="onBudgetDraftChange('${it.id}','amount',this.value)"
          >
          <select
            ${st.locked ? "disabled" : ""}
            onchange="onBudgetDraftChange('${it.id}','payer',this.value)"
          >
            ${PAYERS.map(p=>`<option value="${p}" ${p===payer?"selected":""}>${p}</option>`).join("")}
          </select>
        </div>
        <div class="budget-actions">
          <button class="btn" onclick="enableBudgetEdit('${it.id}')">âœï¸ ç·¨è¼¯</button>
          <button class="btn nav flex-1 justify-center" onclick="saveBudget('${it.id}')">ğŸ’¾ å„²å­˜</button>
          <button class="btn flex-1 justify-center" onclick="deleteBudget('${it.id}')">ğŸ—‘ åˆªé™¤</button>
        </div>
      </div>
    </div>
  `;
}

function renderBudget(){
  const list = document.getElementById("budget-list");
  if(!list) return;
  list.innerHTML = (budgetItems||[]).map(renderBudgetItem).join("");

  const total = (budgetItems||[]).reduce((s,it)=>s+(Number(it.amount)||0),0);
  const totalBox = document.getElementById("budget-total");
  if(totalBox) totalBox.textContent = `åˆè¨ˆï¼š${total.toLocaleString()} JPY`;
}

function getBudgetIndex(id){
  return budgetItems.findIndex(x=>x.id === id);
}

function onBudgetDraftChange(id, field, value){
  const idx = getBudgetIndex(id);
  if(idx===-1) return;
  if(field==="amount"){
    budgetItems[idx].amount = value==="" ? 0 : Number(value||0);
  }else{
    budgetItems[idx][field] = value;
  }
  calcSettlement();
}

function toggleBudgetExpand(id){
  if(!budgetState[id]) budgetState[id] = {expanded:false, locked:true};
  budgetState[id].expanded = !budgetState[id].expanded;
  renderBudget();
}

function enableBudgetEdit(id){
  if(!budgetState[id]) budgetState[id] = {expanded:true, locked:false};
  budgetState[id].locked = false;
  budgetState[id].expanded = true;
  renderBudget();

  setTimeout(()=>{
    const card = document.querySelector(`.budget-card[data-id="${id}"]`);
    if(!card) return;
    const input = card.querySelector("input[placeholder='é …ç›®']");
    if(input) input.focus();
  },0);
}

async function saveBudget(id){
  const idx = getBudgetIndex(id);
  if(idx===-1) return;
  const it = budgetItems[idx];
  const note = it.note || "";
  const amount = Number(it.amount)||0;
  const payer = (it.payer || PAYERS[0]).trim() || PAYERS[0];

  await updateBudgetItem(id, { note, amount, payer });

  if(!budgetState[id]) budgetState[id] = {expanded:true, locked:true};
  budgetState[id].locked = true;

  renderBudget();
  calcSettlement();
}

async function addBudgetRow(){
  await insertBudgetItem("", 0, PAYERS[0]);
  await reloadBudget();
}

async function resetBudget(){
  if(!confirm("ç¢ºå®šè¦æ¸…ç©ºé›²ç«¯è¨˜å¸³å—ï¼Ÿ")) return;
  await clearAllBudget();
  budgetItems = [];
  for(const k in budgetState) delete budgetState[k];
  renderBudget();
  calcSettlement();
}

async function deleteBudget(id){
  await deleteBudgetItem(id);
  budgetItems = budgetItems.filter(x=>x.id !== id);
  delete budgetState[id];
  renderBudget();
  calcSettlement();
}

/* ---- çµç®—é‚è¼¯ ---- */
function calcSettlement(){
  const items = budgetItems || [];
  const fx = Number(localStorage.getItem(FX_KEY) || 0.21);
  const totalJPY = items.reduce((s,it)=>s+(Number(it.amount)||0),0);
  const members = PAYERS.slice();
  const n = members.length;
  const shareJPY = n ? totalJPY / n : 0;

  const paidBy = Object.fromEntries(members.map(p=>[p,0]));
  items.forEach(it=>{
    const p = (it.payer||"").trim();
    if(paidBy[p]!=null) paidBy[p] += Number(it.amount)||0;
  });

  const net = members.map(p=>({name:p, paid:paidBy[p], net:paidBy[p]-shareJPY}));
  const creditors = net.filter(x=>x.net>0.01).sort((a,b)=>b.net-a.net);
  const debtors = net.filter(x=>x.net<-0.01).sort((a,b)=>a.net-b.net);

  const transfers = [];
  let ci=0, di=0;
  while(ci<creditors.length && di<debtors.length){
    const c = creditors[ci], d = debtors[di];
    const amt = Math.min(c.net, -d.net);
    transfers.push({from:d.name, to:c.name, amount:amt});
    c.net -= amt;
    d.net += amt;
    if(c.net<=0.01) ci++;
    if(d.net>=-0.01) di++;
  }

  const sumBox = document.getElementById("budget-summary");
  if(sumBox){
    sumBox.innerHTML = `
      <div class="mt-2">
        <div class="font-extrabold">ä»˜æ¬¾çµ±è¨ˆ</div>
        ${members.map(p=>`<div class="flex justify-between"><span>${escapeHtml(p)}</span><span class="font-black">${(paidBy[p]||0).toLocaleString()} JPY / ${(paidBy[p]*fx).toFixed(0)} TWD</span></div>`).join("")}
        <div class="flex justify-between mt-1 border-t pt-1"><span>æ¯äººå¹³å‡</span><span class="font-black">${shareJPY.toFixed(0)} JPY / ${(shareJPY*fx).toFixed(0)} TWD</span></div>
      </div>
    `;
  }

  const setBox = document.getElementById("budget-settlement");
  if(setBox){
    if(!transfers.length){
      setBox.innerHTML = `<div class="mt-2 font-extrabold">âœ… å·²å¹³è¡¡ï¼Œä¸ç”¨äº’ç›¸è½‰å¸³</div>`;
    }else{
      setBox.innerHTML = `
        <div class="mt-2 font-extrabold">çµç®—å»ºè­°</div>
        ${transfers.map(t=>`<div class="flex justify-between"><span>${escapeHtml(t.from)} â†’ ${escapeHtml(t.to)}</span><span class="font-black">${t.amount.toFixed(0)} JPY / ${(t.amount*fx).toFixed(0)} TWD</span></div>`).join("")}
      `;
    }
  }

  const total = totalJPY;
  const totalBox = document.getElementById("budget-total");
  if(totalBox) totalBox.textContent = `åˆè¨ˆï¼š${total.toLocaleString()} JPY`;
}

/* ---- Supabase Realtimeï¼šå¤šè£ç½®åŒæ­¥ ---- */
/* ---- Supabase Realtimeï¼šå¤šè£ç½®åŒæ­¥ï¼ˆå®‰å…¨ç‰ˆæœ¬ï¼‰ ---- */
function setupBudgetRealtime(){
  if(!supabaseClient) return;

  try{
    const channel = supabaseClient
      .channel('budgets-channel')
      .on(
        'postgres_changes',
        { event:'*', schema:'public', table:'budgets', filter:"trip_id=eq." + TRIP_ID },
        function(payload){
          reloadBudget();
        }
      )
      .subscribe(function(status){
        if(status === 'SUBSCRIBED'){
          console.log("Realtime å·²é€£ç·š");
        }
      });

    // Realtime å‡ºéŒ¯æ™‚ï¼Œå°±ç•¶ä½œåªç”¨æœ¬æ©Ÿè³‡æ–™ï¼Œä¸è¦è®“ç•«é¢æ›æ‰
    if(channel && typeof channel.on === "function"){
      channel.on("error", function(e){
        console.warn("Realtime é€£ç·šå¤±æ•—ï¼Œæ”¹ç”¨æœ¬æ©Ÿæ¨¡å¼", e);
      });
    }
  }catch(e){
    console.warn("Realtime åˆå§‹åŒ–å¤±æ•—ï¼Œåƒ…ä½¿ç”¨æœ¬æ©Ÿè¨˜å¸³è³‡æ–™", e);
  }
}


/* ---------- Map Modalï¼ˆä¿ç•™ KEY + Fallbackï¼‰ ---------- */
const mapModal = document.getElementById("mapModal");
const mapModalMap = document.getElementById("mapModalMap");
const mapModalTitle = document.getElementById("mapModalTitle");

function openMapModal(title, embedUrl){
  mapModalTitle.textContent = title || "åœ°åœ–";
  mapModalMap.innerHTML = `<div class="modal-loading">åœ°åœ–è¼‰å…¥ä¸­â€¦</div>`;

  function mountIframe(src){
    const iframe = document.createElement("iframe");
    iframe.src = src;
    iframe.className = "w-full h-full border-0";
    iframe.loading = "lazy";
    iframe.referrerPolicy = "no-referrer-when-downgrade";
    iframe.allowFullscreen = true;
    iframe.onload = ()=>{
      const loading = mapModalMap.querySelector(".modal-loading");
      if(loading) loading.remove();
    };
    iframe.onerror = ()=>{
      fallbackSimpleMap();
    };
    mapModalMap.appendChild(iframe);
  }

  function fallbackSimpleMap(){
    mapModalMap.innerHTML = `<div class="modal-loading">åˆ‡æ›å‚™ç”¨åœ°åœ–ä¸­â€¦</div>`;
    const q = encodeURIComponent(title || "Osaka");
    const simpleUrl = `https://www.google.com/maps?q=${q}&output=embed`;
    const iframe = document.createElement("iframe");
    iframe.src = simpleUrl;
    iframe.className = "w-full h-full border-0";
    iframe.loading = "lazy";
    iframe.referrerPolicy = "no-referrer-when-downgrade";
    iframe.allowFullscreen = true;
    iframe.onload = ()=>{
      const loading = mapModalMap.querySelector(".modal-loading");
      if(loading) loading.remove();
    };
    iframe.onerror = ()=>{
      mapModalMap.innerHTML = `<div class="w-full h-full flex items-center justify-center text-white text-sm font-bold">ç„¡æ³•è¼‰å…¥åœ°åœ–</div>`;
    };
    mapModalMap.appendChild(iframe);
  }

  if(navigator.onLine && embedUrl){
    mountIframe(embedUrl);
    setTimeout(()=>{
      const loading = mapModalMap.querySelector(".modal-loading");
      if(loading){
        // 4 ç§’é‚„åœ¨ loadingï¼Œå°±ç”¨ç°¡å–®ç‰ˆåœ°åœ–
        mapModalMap.innerHTML = "";
        fallbackSimpleMap();
      }
    }, 4000);
  }else{
    fallbackSimpleMap();
  }

  mapModal.classList.add("show");
}

function closeMapModal(){
  mapModal.classList.remove("show");
  mapModalMap.innerHTML = "";
}
mapModal.addEventListener("click",(e)=>{ if(e.target===mapModal) closeMapModal(); });

/* ---------- Trip Modal (iframe w/ fallback) ---------- */
const tripModal = document.getElementById("tripModal");
const tripModalBody = document.getElementById("tripModalBody");
const tripModalTitle = document.getElementById("tripModalTitle");
function openTripModal(label, url){
  tripModalTitle.textContent = `TRIP.com ${label}`;
  tripModalBody.innerHTML = `<div class="modal-loading">TRIP.com è³‡è¨Šè¼‰å…¥ä¸­â€¦</div>`;
  if(navigator.onLine){
    const iframe = document.createElement("iframe");
    iframe.src = url;
    iframe.className = "w-full h-full border-0";
    iframe.loading = "lazy";
    iframe.onerror = ()=>{
      window.open(url, "_blank");
      closeTripModal();
    };
    iframe.onload = ()=>{
      const loading = tripModalBody.querySelector(".modal-loading");
      if(loading) loading.remove();
    };
    tripModalBody.appendChild(iframe);
    setTimeout(()=>{
      try{
        const doc = iframe.contentDocument;
        if(!doc || (doc.body && (doc.body.innerText.includes("refused") || doc.body.innerText.includes("denied")))){
          window.open(url,"_blank");
          closeTripModal();
        }else{
          const loading = tripModalBody.querySelector(".modal-loading");
          if(loading) loading.remove();
        }
      }catch(e){
        window.open(url,"_blank");
        closeTripModal();
      }
    }, 900);
  }else{
    tripModalBody.innerHTML = `<div class="w-full h-full flex items-center justify-center text-white text-sm font-bold">é›¢ç·šä¸­ï¼Œç„¡æ³•è¼‰å…¥ TRIP.com</div>`;
  }
  tripModal.classList.add("show");
}
function closeTripModal(){
  tripModal.classList.remove("show");
  tripModalBody.innerHTML = "";
}
tripModal.addEventListener("click",(e)=>{ if(e.target===tripModal) closeTripModal(); });

/* ---------- Hotel Modal + room number ---------- */
const hotelModal = document.getElementById("hotelModal");
const ROOM_KEY = "osakaRoomNumberV9milktea";
function openHotelModal(){
  hotelModal.classList.add("show");
  const input = document.getElementById("roomNumberInput");
  input.value = localStorage.getItem(ROOM_KEY) || "";
  input.oninput = ()=>localStorage.setItem(ROOM_KEY, input.value);
}
function closeHotelModal(){
  hotelModal.classList.remove("show");
}
hotelModal.addEventListener("click",(e)=>{ if(e.target===hotelModal) closeHotelModal(); });

/* ---------- Bottom sheetï¼šæ»‘ä¸€ä¸‹å°±é—œ ---------- */
function attachSheetSwipe(sheetId, closeFn){
  const sheet = document.getElementById(sheetId);
  if(!sheet) return;
  let startY = null;
  let lastY = null;

  sheet.addEventListener("touchstart", e=>{
    if(e.touches.length!==1) return;
    startY = e.touches[0].clientY;
    lastY = startY;
  }, {passive:true});

  sheet.addEventListener("touchmove", e=>{
    if(startY==null) return;
    lastY = e.touches[0].clientY;
  }, {passive:true});

  sheet.addEventListener("touchend", ()=>{
    if(startY==null || lastY==null) { startY=null; lastY=null; return; }
    const delta = lastY - startY;
    if(delta > 60){
      closeFn();
    }
    startY = null;
    lastY = null;
  }, {passive:true});
}

/* ---------- Helpers ---------- */
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
}
function escapeAttr(str){
  return escapeHtml(str).replace(/"/g,"&quot;");
}
function escapeJs(str){
  return (str||"").replace(/'/g,"\\'");
}

/* ---------- boot ---------- */
renderItinerary();
renderTools();
loadAllWeather();
showTab('itin');

// modal swipe
attachSheetSwipe("mapSheet", closeMapModal);
attachSheetSwipe("tripSheet", closeTripModal);
attachSheetSwipe("hotelSheet", closeHotelModal);
</script>
</body>
</html>

