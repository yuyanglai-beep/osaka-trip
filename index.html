<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>å¤§é˜ªå››å¤©ä¸‰å¤œï½œè¡Œç¨‹ & è¨˜å¸³ App</title>

  <!-- iOS Web App è¨­å®š -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Osaka Trip" />

  <style>
    :root {
      --brand: #ff7e5f;
      --brand-dark: #f4511e;
      --brand-soft: #ffe0d2;
      --bg: #f8fafc;
      --text-main: #222;
      --text-sub: #666;
      --card-bg: #ffffff;
      --card-border: #e2e8f0;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top, #fff5f2 0, #f8fafc 45%, #e2f3ff 100%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding:
        env(safe-area-inset-top)
        env(safe-area-inset-right)
        env(safe-area-inset-bottom)
        env(safe-area-inset-left);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(16px);
      background: linear-gradient(
        120deg,
        rgba(255, 255, 255, 0.96),
        rgba(255, 255, 255, 0.9)
      );
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .header-inner {
      padding: 10px 18px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.04em;
      color: #111827;
    }

    .app-subtitle {
      font-size: 12px;
      color: #6b7280;
    }

    .weather-brief {
      font-size: 12px;
      color: #0f766e;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .weather-brief-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    main.content {
      flex: 1;
      padding: 10px 14px 18px;
    }

    /* å¡ç‰‡å…±ç”¨ */
    .info-card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      padding: 12px 14px 13px;
      border: 1px solid rgba(226, 232, 240, 0.95);
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
    }

    .info-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .info-title {
      font-size: 16px;
      font-weight: 700;
    }

    .info-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid rgba(191, 219, 254, 0.9);
    }

    .info-line {
      font-size: 13px;
      color: #374151;
      margin: 2px 0;
    }

    /* è¨˜å¸³å€ */
    .money-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 14px;
    }

    .money-top {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pill-note {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0369a1;
      border: 1px dashed rgba(56, 189, 248, 0.8);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .expense-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .expense-form input,
    .expense-form select {
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      font-size: 14px;
      min-width: 120px;
      flex: 1 1 120px;
      background: #f8fafc;
    }

    .expense-form button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.35);
      flex: 0 0 auto;
    }

    .expense-form button:hover {
      filter: brightness(1.03);
    }

    .expense-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .expense-item {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      padding: 10px 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      position: relative;
    }

    .expense-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .expense-main-title {
      font-size: 14px;
      font-weight: 600;
    }

    .expense-note {
      font-size: 12px;
      color: #6b7280;
    }

    .money-summary {
      font-size: 14px;
      margin-top: 6px;
    }

    .money-summary strong {
      color: #0f172a;
    }

    .settlement-text {
      font-size: 15px;
      font-weight: 700;
      margin-top: 4px;
      color: #b91c1c;
    }

    .menu-btn {
      font-size: 20px;
      cursor: pointer;
      padding: 2px 6px;
      color: #94a3b8;
    }

    .menu-panel {
      position: absolute;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
      padding: 6px 0;
      display: none;
      z-index: 200;
      min-width: 120px;
      border: 1px solid #e2e8f0;
    }

    .menu-panel.show {
      display: block;
    }

    .menu-item {
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      color: #374151;
    }

    .menu-item:hover {
      background: #f3f4f6;
    }

    /* è¡Œç¨‹ Layoutï¼šå·¦ Day Bar / å³ Timeline */
    .plan-layout {
      margin-top: 4px;
      display: flex;
      flex-direction: row;
      gap: 10px;
      align-items: flex-start;
    }

    .day-list {
      width: 100px; /* ä½ æŒ‡å®šçš„ Aï¼š100px */
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: sticky;
      top: 70px; /* header ä¸‹æ–¹ä¸€é» */
      align-self: flex-start;
    }

    .day-pill {
      border-radius: 18px;
      border: 1px solid #e2e8f0;
      padding: 8px 8px;
      font-size: 12px;
      text-align: left;
      background: rgba(255, 255, 255, 0.92);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: #475569;
      transition: background 0.18s ease, border-color 0.18s ease,
        transform 0.1s ease, box-shadow 0.18s ease;
    }

    .day-pill span {
      font-size: 11px;
      color: #94a3b8;
    }

    .day-pill.active {
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(249, 115, 22, 0.35);
      transform: translateY(-1px);
    }

    .day-pill.active span {
      color: #ffe4e6;
    }

    .plan-timeline-container {
      flex: 1;
      min-width: 0;
    }

    .day-timeline {
      display: none;
    }

    .day-timeline.active {
      display: block;
    }

    /* Day header card */
    .day-header-card {
      background: linear-gradient(135deg, #fff7ed, #ffe4e6);
      border-radius: var(--radius-lg);
      padding: 14px 14px 13px;
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(251, 113, 133, 0.25);
    }

    .day-title {
      font-size: 18px;
      font-weight: 800;
      color: #9a3412;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .day-chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #475569;
      font-weight: 600;
    }

    .day-highlight {
      font-size: 13px;
      color: #7c2d12;
    }

    /* Timeline / event cards */
    .timeline {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }

    .event-card {
      position: relative;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease, background 0.12s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .event-card::before {
      content: "";
      position: absolute;
      left: 8px;
      top: 12px;
      bottom: 12px;
      width: 3px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--brand), #facc15);
      opacity: 0.9;
    }

    .event-time-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding-left: 12px;
      gap: 2px;
      min-width: 92px;
    }

    .event-time {
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
    }

    .event-tag {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid rgba(191, 219, 254, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .event-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .event-title {
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }

    .event-desc {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.5;
    }

    .event-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .event-pill {
      font-size: 11px;
      padding: 1px 7px;
      border-radius: 999px;
      background: #f1f5f9;
      color: #475569;
    }

    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.16);
      border-color: rgba(248, 113, 22, 0.5);
      background: #ffffff;
    }

    .event-card:active {
      transform: scale(0.99);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
    }

    /* Modal åº•éƒ¨æŠ½å±œ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
      padding: 14px 14px calc(16px + env(safe-area-inset-bottom));
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-box {
      width: 100%;
      max-width: 520px;
      background: #0f172a;
      border-radius: 22px 22px 0 0;
      overflow: hidden;
      box-shadow: 0 -10px 40px rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.45);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-img {
      width: 100%;
      height: 210px;
      object-fit: cover;
      background: #020617;
      display: block;
    }

    .modal-body {
      padding: 14px 15px 13px;
      color: #e5e7eb;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .modal-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .modal-desc {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .btn-primary,
    .btn-ghost {
      flex: 1;
      border-radius: 999px;
      padding: 9px 0;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
    }

    /* å¤©æ°£ Error Tag */
    .weather-tag-error {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    /* RWDï¼šçª„è¢å¹•å°±ä¸Šä¸‹å †ç–Šï¼ˆDay Bar åœ¨ä¸Šï¼‰ */
    @media (max-width: 720px) {
      .plan-layout {
        flex-direction: column;
      }

      .day-list {
        position: static;
        flex-direction: row;
        width: 100%;
        overflow-x: auto;
      }

      .day-pill {
        min-width: 90px;
      }
    }

    @media (min-width: 720px) {
      main.content {
        padding-inline: 18px;
      }

      .expense-form {
        flex-wrap: nowrap;
      }
    }
  </style>
</head>

<body>
<div class="app-shell">
  <header>
    <div class="header-inner">
      <div class="app-title">å¤§é˜ªå››å¤©ä¸‰å¤œ Â· è¡Œç¨‹ & è¨˜å¸³</div>
      <div class="app-subtitle">12/5â€“12/8 Â· å¤§é˜ªåŸ Â· äº¬ç“·å·¨è›‹ Â· å‹å°¾å¯º Â· é›£æ³¢å¿ƒé½‹æ©‹</div>
      <div class="weather-brief" id="weather-brief">
        <span class="weather-brief-dot"></span>
        å¤§é˜ªå¤©æ°£è®€å–ä¸­â€¦
      </div>
    </div>
  </header>

  <main class="content">
    <!-- è¨˜å¸³å€å¡Šï¼ˆHeader ä¸‹ï¼‰ -->
    <section class="money-layout">
      <div class="info-card">
        <div class="info-title-row">
          <div class="info-title">ğŸ’´ æ—¥å¹£è¨˜å¸³å°å·¥å…·</div>
          <span class="info-tag">AA çµç®— Â· Supabase</span>
        </div>
        <div class="money-top">
          <div class="pill-note">
            ğŸ’¡ é‡‘é¡ä»¥ã€Œæ—¥å¹£ã€è¼¸å…¥ï¼Œæˆ‘æœƒè‡ªå‹•æŠ“å°éŠ€æ—¥å¹£åŒ¯ç‡æ›ç®—æˆå°å¹£ã€‚
          </div>

          <form id="expense-form" class="expense-form">
            <input type="number" id="exp-amount" placeholder="é‡‘é¡ï¼ˆæ—¥å¹£ï¼‰" inputmode="numeric" required>
            <select id="exp-payer">
              <option value="ç¾Š">ç¾Š</option>
              <option value="ç†™">ç†™</option>
            </select>
            <input type="text" id="exp-note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰">
            <button type="submit">æ–°å¢</button>
          </form>
        </div>
      </div>

      <div class="info-card">
        <div class="info-title-row">
          <div class="info-title">ğŸ“’ è¨˜å¸³åˆ—è¡¨</div>
        </div>
        <div id="expense-list" class="expense-list"></div>
        <div class="money-summary">
          <strong id="expense-total"></strong>
        </div>
        <div class="settlement-text">
          <span id="settlement"></span>
        </div>
      </div>
    </section>

    <!-- è¡Œç¨‹ Layoutï¼šå·¦ Day Bar / å³ Timeline -->
    <section class="plan-layout">
      <!-- å·¦ï¼šDay Bar -->
      <aside class="day-list">
        <button class="day-pill active" data-day="day1">
          Day 1
          <span>å¤§é˜ªåŸ & é“é “å €</span>
        </button>
        <button class="day-pill" data-day="day2">
          Day 2
          <span>é»‘é–€ & å·¨è›‹</span>
        </button>
        <button class="day-pill" data-day="day3">
          Day 3
          <span>å‹å°¾å¯º & æ¢…ç”°</span>
        </button>
        <button class="day-pill" data-day="day4">
          Day 4
          <span>é€€æˆ¿ & å›å®¶</span>
        </button>
      </aside>

      <!-- å³ï¼šç•¶å¤©è¡Œç¨‹ Timeline -->
      <div class="plan-timeline-container">
        <!-- Day1 Timeline -->
        <div class="day-timeline active" data-day="day1">
          <div class="day-header-card">
            <div class="day-title">
              12/5ï¼ˆäº”ï¼‰ Day 1
              <span class="day-chip">æ—©ç­æ©Ÿï¼‹å¤§é˜ªåŸï¼‹é“é “å €</span>
            </div>
            <div class="day-highlight">
              âœˆï¸ æŠµé”é—œè¥¿ â†’ ğŸš„ å—æµ·ç‰¹æ€¥åˆ°é›£æ³¢ â†’ ğŸ¯ å¤§é˜ªåŸ â†’ ğŸ› å¿ƒé½‹æ©‹ & é“é “å €
            </div>
          </div>

          <div class="timeline">
            <article class="event-card" onclick="openModal(day1[0], '12/5')">
              <div class="event-time-block">
                <div class="event-time">02:30 â†’ 06:00</div>
                <div class="event-tag">âœˆï¸ å»ç¨‹ Â· GK050</div>
              </div>
              <div class="event-main">
                <div class="event-title">GK050 æ¡ƒåœ’ T1 â†’ é—œè¥¿ T1</div>
                <div class="event-desc">ç´…çœ¼ç­æ©ŸæŠµé”é—œè¥¿ï¼Œå…ˆé†’é†’è…¦ã€æ…¢æ…¢å‡ºé—œã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day1[1], '12/5')">
              <div class="event-time-block">
                <div class="event-time">07:30 â†’ 09:00</div>
                <div class="event-tag">ğŸš„ å—æµ·ç‰¹æ€¥</div>
              </div>
              <div class="event-main">
                <div class="event-title">å—æµ·ç‰¹æ€¥ â†’ é›£æ³¢</div>
                <div class="event-desc">æ­æ‹‰çš®ç‰¹ï¼å—æµ·ç‰¹æ€¥é€²å¤§é˜ªå¸‚å€ï¼Œæ­£å¼é–‹å•Ÿæ—…ç¨‹ã€‚</div>
                <div class="event-pill-row">
                  <span class="event-pill">è»Šç¥¨å¯é å…ˆè³¼è²·</span>
                </div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day1[2], '12/5')">
              <div class="event-time-block">
                <div class="event-time">09:30 â†’ 10:00</div>
                <div class="event-tag">ğŸ§³ é£¯åº—å¯„ç‰©</div>
              </div>
              <div class="event-main">
                <div class="event-title">å¯„è¡Œæ</div>
                <div class="event-desc">å…ˆåˆ° Dormy Inn Premium Nanba ANNEX å¯„æ”¾è¡Œæï¼Œè§£æ”¾é›™æ‰‹ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day1[3], '12/5')">
              <div class="event-time-block">
                <div class="event-time">10:30 â†’ 12:30</div>
                <div class="event-tag">ğŸ¯ åŸå ¡æ•£æ­¥</div>
              </div>
              <div class="event-main">
                <div class="event-title">å¤§é˜ªåŸæ•£ç­–</div>
                <div class="event-desc">åœ¨å¤§é˜ªåŸå…¬åœ’æ•£æ­¥ã€æ‹ç…§ï¼Œè¦–é«”åŠ›æ±ºå®šè¦ä¸è¦é€²å¤©å®ˆé–£ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day1[4], '12/5')">
              <div class="event-time-block">
                <div class="event-time">13:30 â†’ 14:30</div>
                <div class="event-tag">ğŸ¥© ç‰›èˆŒåˆé¤</div>
              </div>
              <div class="event-main">
                <div class="event-title">åˆé¤ï¼šå‰æ¬¡ç‰›èˆŒ é°»è°·åº—</div>
                <div class="event-desc">åšåˆ‡ç‰›èˆŒé…éº¥é£¯ï¼Œè£œå›æ—©ç­æ©Ÿçš„é«”åŠ›ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day1[5], '12/5')">
              <div class="event-time-block">
                <div class="event-time">15:30 â†’ 16:30</div>
                <div class="event-tag">â˜• ä¸‹åˆèŒ¶ & Check-in</div>
              </div>
              <div class="event-main">
                <div class="event-title">Check-in & ä¸‹åˆèŒ¶</div>
                <div class="event-desc">å›é£¯åº— check-inï¼Œå†åˆ°å¿ƒé½‹æ©‹é™„è¿‘å–å’–å•¡ã€åƒç”œé»ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day1[6], '12/5')">
              <div class="event-time-block">
                <div class="event-time">17:30 â†’ 19:00</div>
                <div class="event-tag">ğŸ½ æ™šé¤</div>
              </div>
              <div class="event-main">
                <div class="event-title">æ™šé¤ï¼šæ¿å‰ç‡’è‚‰ä¸€æ–—ï¼å¤§èµ·æ°´ç”¢</div>
                <div class="event-desc">çœ‹ç•¶å¤©å¿ƒæƒ…æ±ºå®šæ˜¯ç‡’è‚‰é‚„æ˜¯è¿´è½‰å£½å¸ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day1[7], '12/5')">
              <div class="event-time-block">
                <div class="event-time">19:00 â†’ 21:30</div>
                <div class="event-tag">ğŸ› å¤œé€›é“é “å €</div>
              </div>
              <div class="event-main">
                <div class="event-title">é“é “å € & å¿ƒé½‹æ©‹é€›è¡—</div>
                <div class="event-desc">ç« é­šç‡’ã€æ‰­è›‹ã€è—¥å¦ã€è·‘è·‘äººã€æ‘©å¤©è¼ªã€ç¾åœ‹æ‘ä¸€æ¬¡è’é›†ã€‚</div>
              </div>
            </article>
          </div>
        </div>

        <!-- Day2 Timeline -->
        <div class="day-timeline" data-day="day2">
          <div class="day-header-card">
            <div class="day-title">
              12/6ï¼ˆå…­ï¼‰ Day 2
              <span class="day-chip">é»‘é–€å¸‚å ´ï¼‹æ–°ä¸–ç•Œï¼‹Seventeen</span>
            </div>
            <div class="day-highlight">
              ğŸ£ é»‘é–€å¸‚å ´é–‹åƒ â†’ â›© é›£æ³¢å…«é˜ªç¥ç¤¾ â†’ ğŸ—¼ é€šå¤©é–£æ–°ä¸–ç•Œ â†’ ğŸ¤ äº¬ç“·å·¨è›‹æ¼”å”±æœƒ
            </div>
          </div>

          <div class="timeline">
            <article class="event-card" onclick="openModal(day2[0], '12/6')">
              <div class="event-time-block">
                <div class="event-time">09:00 â†’ 10:30</div>
                <div class="event-tag">ğŸ£ æ—©åˆé¤è¡Œç¨‹</div>
              </div>
              <div class="event-main">
                <div class="event-title">é»‘é–€å¸‚å ´</div>
                <div class="event-desc">é®ªé­šã€èŸ¹è…³ã€é—œæ±ç…®ã€å°åƒï¼Œé‚Šé€›é‚Šåƒçš„æµ·é®®å¸‚å ´ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day2[1], '12/6')">
              <div class="event-time-block">
                <div class="event-time">11:00 â†’ 12:30</div>
                <div class="event-tag">ğŸ™ é›£æ³¢æ•£æ­¥</div>
              </div>
              <div class="event-main">
                <div class="event-title">é›£æ³¢å•†åœˆ & é›£æ³¢å…«é˜ªç¥ç¤¾</div>
                <div class="event-desc">é€›ç™¾è²¨ï¼Œé †è·¯å»çœ‹å·¨å¤§ç…å­é ­ç¥ç¤¾ï¼Œæ‹å¹¾å¼µé…·ç…§ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day2[2], '12/6')">
              <div class="event-time-block">
                <div class="event-time">13:30 â†’ 15:30</div>
                <div class="event-tag">ğŸ—¼ æ–°ä¸–ç•Œ</div>
              </div>
              <div class="event-main">
                <div class="event-title">åˆé¤ & é€šå¤©é–£ æ–°ä¸–ç•Œ</div>
                <div class="event-desc">é€šå¤©é–£å‘¨é‚Šã€é”æ‘©ä¸²ç‚¸ã€Usagiya ç”œé»ï¼Œè€å¤§é˜ªæ°›åœã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day2[3], '12/6')">
              <div class="event-time-block">
                <div class="event-time">16:00 â†’ 21:00</div>
                <div class="event-tag">ğŸ¤ Seventeen</div>
              </div>
              <div class="event-main">
                <div class="event-title">Seventeen in å¤§é˜ªäº¬ç“·å·¨è›‹</div>
                <div class="event-desc">16:00 é–‹å§‹å…¥å ´ï¼Œè¨˜å¾—ç¥¨åˆ¸ã€æ‰‹ç‡ˆã€æ‡‰æ´ç‰©å…¨éƒ¨å¸¶å¥½ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day2[4], '12/6')">
              <div class="event-time-block">
                <div class="event-time">21:30 â†’ 23:00</div>
                <div class="event-tag">ğŸŒƒ å®µå¤œ</div>
              </div>
              <div class="event-main">
                <div class="event-title">æ¼”å”±æœƒå¾Œæ™šé¤</div>
                <div class="event-desc">å›é›£æ³¢åƒä¸€è˜­æˆ–ä¸²ç‡’ï¼Œå¥½å¥½æ”¶å°¾ä»Šå¤©çš„è¡Œç¨‹ã€‚</div>
              </div>
            </article>
          </div>
        </div>

        <!-- Day3 Timeline -->
        <div class="day-timeline" data-day="day3">
          <div class="day-header-card">
            <div class="day-title">
              12/7ï¼ˆæ—¥ï¼‰ Day 3
              <span class="day-chip">å‹å°¾å¯ºï¼‹æ¢…ç”°é€›è¡—</span>
            </div>
            <div class="day-highlight">
              â˜• è¼•é¬†æ—©åˆé¤ â†’ â›© å‹å°¾å¯ºé”æ‘©ç±¤ â†’ ğŸ™ æ¢…ç”°é€›è¡— & ç”œé» â†’ ğŸ½ æ¢…ç”°æ™šé¤
            </div>
          </div>

          <div class="timeline">
            <article class="event-card" onclick="openModal(day3[0], '12/7')">
              <div class="event-time-block">
                <div class="event-time">08:00 â†’ 09:00</div>
                <div class="event-tag">â˜• Brunch</div>
              </div>
              <div class="event-main">
                <div class="event-title">æ—©åˆé¤</div>
                <div class="event-desc">å®¢ç¾å¤šã€HARBS æˆ–é™„è¿‘å’–å•¡å»³ï¼ŒæŒ‘ä¸€é–“å–œæ­¡çš„æ…¢æ…¢åƒã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day3[1], '12/7')">
              <div class="event-time-block">
                <div class="event-time">11:00 â†’ 14:30</div>
                <div class="event-tag">â›© å‹å°¾å¯º</div>
              </div>
              <div class="event-main">
                <div class="event-title">å‹å°¾å¯ºåŠæ—¥éŠ</div>
                <div class="event-desc">æ­åˆ°ç®•é¢è±é‡è½‰å·´å£«ä¸Šå±±ï¼Œè²·é”æ‘©ç±¤ã€è“‹ç« ã€æ‹ç…§çœ‹é¢¨æ™¯ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day3[2], '12/7')">
              <div class="event-time-block">
                <div class="event-time">15:00 â†’ 16:30</div>
                <div class="event-tag">ğŸ± åˆé¤</div>
              </div>
              <div class="event-main">
                <div class="event-title">æ¢…ç”° åˆé¤</div>
                <div class="event-desc">new babe ç‚¸è±¬æ’æˆ–å…¶ä»–æ¢…ç”°è»Šç«™é™„è¿‘çš„é¤å»³ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day3[3], '12/7')">
              <div class="event-time-block">
                <div class="event-time">17:00 â†’ 19:00</div>
                <div class="event-tag">ğŸ° ç”œé» & é€›è¡—</div>
              </div>
              <div class="event-main">
                <div class="event-title">æ¢…ç”° ç”œé» & é€›è¡—</div>
                <div class="event-desc">LUCUAã€HEP FIVEã€å¤§ä¸¸æ¢…ç”°é€›ä¸€åœˆï¼Œåƒåƒå±¤é…¥æˆ– HARBSã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day3[4], '12/7')">
              <div class="event-time-block">
                <div class="event-time">19:00 â†’ 21:00</div>
                <div class="event-tag">ğŸ½ æ™šé¤</div>
              </div>
              <div class="event-main">
                <div class="event-title">æ¢…ç”° æ™šé¤</div>
                <div class="event-desc">ç‚¸ç‰›å…ƒæ‘æˆ–å…¶ä»–å±…é…’å±‹ï¼Œä¾ç•¶å¤©å¿ƒæƒ…é¸ä¸€å®¶æ”¶å°¾ã€‚</div>
              </div>
            </article>
          </div>
        </div>

        <!-- Day4 Timeline -->
        <div class="day-timeline" data-day="day4">
          <div class="day-header-card">
            <div class="day-title">
              12/8ï¼ˆä¸€ï¼‰ Day 4
              <span class="day-chip">é€€æˆ¿ï¼‹å›å®¶æ—¥</span>
            </div>
            <div class="day-highlight">
              ğŸ§³ é€€æˆ¿ â†’ ğŸš„ å—æµ·ç‰¹æ€¥ â†’ âœˆï¸ KIX â†’ ğŸ  å›æ¡ƒåœ’
            </div>
          </div>

          <div class="timeline">
            <article class="event-card" onclick="openModal(day4Data[0], '12/8')">
              <div class="event-time-block">
                <div class="event-time">08:00</div>
                <div class="event-tag">ğŸ§³ Check-out</div>
              </div>
              <div class="event-main">
                <div class="event-title">é€€æˆ¿</div>
                <div class="event-desc">ç¢ºèªè¡Œæã€ç¥¨åˆ¸ã€è­·ç…§ã€æˆ°åˆ©å“éƒ½æ”¶å¥½äº†å†å‡ºé–€ã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day4Data[1], '12/8')">
              <div class="event-time-block">
                <div class="event-time">09:00 â†’ 10:00</div>
                <div class="event-tag">ğŸš„ å‰å¾€æ©Ÿå ´</div>
              </div>
              <div class="event-main">
                <div class="event-title">å—æµ·ç‰¹æ€¥ â†’ é—œè¥¿ç©ºæ¸¯</div>
                <div class="event-desc">å¾é›£æ³¢æ­å—æµ·ç‰¹æ€¥å‰å¾€é—œè¥¿æ©Ÿå ´ï¼Œé ç•™æ™‚é–“è¾¦ç†ç™»æ©Ÿã€‚</div>
              </div>
            </article>

            <article class="event-card" onclick="openModal(day4Data[2], '12/8')">
              <div class="event-time-block">
                <div class="event-time">12:55 â†’ 15:05</div>
                <div class="event-tag">âœˆï¸ å›ç¨‹ Â· BR131</div>
              </div>
              <div class="event-main">
                <div class="event-title">BR131 é—œè¥¿ â†’ æ¡ƒåœ’</div>
                <div class="event-desc">çµæŸå››å¤©ä¸‰å¤œå¤§é˜ªæ—…ç¨‹ï¼Œå¸¶è‘—ç…§ç‰‡èˆ‡æˆ°åˆ©å“å›å®¶ã€‚</div>
              </div>
            </article>
          </div>
        </div>

      </div>
    </section>
  </main>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal-backdrop" onclick="backdropClick(event)">
  <div class="modal-box">
    <img class="modal-img" id="modal-img" alt="æ™¯é»åœ–ç‰‡">
    <div class="modal-body">
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-sub" id="modal-sub"></div>
      <div class="modal-desc" id="modal-desc"></div>
      <div class="modal-buttons">
        <button class="btn-primary" id="modal-nav-btn">åœ°åœ–</button>
        <button class="btn-ghost" onclick="closeModal()">é—œé–‰</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  /* -------- è¡Œç¨‹è³‡æ–™ -------- */
  const day1 = [
    {
      title: "GK050 æ¡ƒåœ’ T1 â†’ é—œè¥¿ T1",
      placeName: "Kansai International Airport",
      desc: "ç´…çœ¼ç­æ©Ÿï¼ŒæŠµé”é—œè¥¿æ©Ÿå ´ T1ã€‚è¨˜å¾—å…ˆè£œå……æ°´åˆ†ã€ä¸Šæ´—æ‰‹é–“ã€‚",
      mapsQuery: "Kansai International Airport"
    },
    {
      title: "å—æµ·ç‰¹æ€¥ â†’ é›£æ³¢",
      placeName: "å—æµ·é›»éµ é›£æ³¢ç«™",
      desc: "å¾é—œè¥¿æ©Ÿå ´æ­å—æµ·ç‰¹æ€¥æˆ–æ‹‰çš®ç‰¹ï¼Œç›´é”é›£æ³¢ç«™ã€‚",
      mapsQuery: "Nankai Namba Station"
    },
    {
      title: "å¯„è¡Œæ",
      placeName: "Dormy Inn Premium Nanba Annex",
      desc: "å…ˆåˆ°é£¯åº—å¯„æ”¾è¡Œæï¼Œè§£æ”¾é›™æ‰‹å†é–‹å§‹ç©ã€‚",
      mapsQuery: "Dormy Inn Premium Nanba Annex"
    },
    {
      title: "å¤§é˜ªåŸæ•£ç­–",
      placeName: "Osaka Castle",
      desc: "å¤§é˜ªä»£è¡¨æ™¯é»ï¼Œé©åˆæ‹ç…§ã€æ•£æ­¥ã€çœ‹å¤©å®ˆé–£ã€‚",
      mapsQuery: "Osaka Castle"
    },
    {
      title: "åˆé¤ï¼šå‰æ¬¡ç‰›èˆŒ é°»è°·åº—",
      placeName: "å‰æ¬¡ç‰›èˆŒ é°»è°·åº—",
      desc: "ä¸»æ‰“åšåˆ‡ç‰›èˆŒï¼Œæ­é…å±±è—¥æ³¥ã€éº¥é£¯ã€‚",
      mapsQuery: "å‰æ¬¡ç‰›èˆŒ é°»è°·åº—"
    },
    {
      title: "Check-in & ä¸‹åˆèŒ¶",
      placeName: "å¿ƒé½‹æ©‹å‘¨é‚Šå’–å•¡åº—",
      desc: "Check-in å¾Œåœ¨å¿ƒé½‹æ©‹é™„è¿‘æ‰¾å¯éº—é¤…ã€è—ç“¶å’–å•¡æˆ– MooKEN æ³¡èŠ™ç•¶ä¸‹åˆèŒ¶ã€‚",
      mapsQuery: "Shinsaibashi Osaka cafes"
    },
    {
      title: "æ™šé¤ï¼šæ¿å‰ç‡’è‚‰ä¸€æ–—ï¼å¤§èµ·æ°´ç”¢",
      placeName: "æ¿å‰ç„¼è‚‰ ä¸€æ–— æ±å¿ƒé½‹æ©‹åº— æˆ– å¤§èµ·æ°´ç”¢ é“é “å €åº—",
      desc: "ç‡’è‚‰æˆ–è¿´è½‰å£½å¸äºŒé¸ä¸€ï¼Œè¦–ç•¶å¤©å¿ƒæƒ…æ±ºå®šã€‚",
      mapsQuery: "æ¿å‰ç„¼è‚‰ ä¸€æ–— æ±å¿ƒæ–æ©‹åº—"
    },
    {
      title: "é“é “å € & å¿ƒé½‹æ©‹é€›è¡—",
      placeName: "é“é “å €ãƒ»å¿ƒé½‹æ©‹å•†åº—è¡—",
      desc: "é€›è—¥å¦ã€æ‰­è›‹ã€ç« é­šç‡’ã€è·‘è·‘äººæ‹›ç‰Œã€ç¾åœ‹æ‘ä¸€å¸¶ã€‚",
      mapsQuery: "Dotonbori Shinsaibashi"
    }
  ];

  const day2 = [
    {
      title: "é»‘é–€å¸‚å ´",
      placeName: "é»’é–€å¸‚å ´",
      desc: "åƒé®ªé­šã€èŸ¹è…³ã€å°åƒã€é—œæ±ç…®ç­‰æµ·é®®èˆ‡ç†Ÿé£Ÿã€‚",
      mapsQuery: "Kuromon Ichiba Market"
    },
    {
      title: "é›£æ³¢å•†åœˆ & é›£æ³¢å…«é˜ªç¥ç¤¾",
      placeName: "é›£æ³¢å…«é˜ªç¥ç¤¾",
      desc: "é€›é›£æ³¢CITYã€ç™¾è²¨ï¼Œå†å»çœ‹è¶…å·¨å¤§çš„ç…å­é ­ç¥ç¤¾ã€‚",
      mapsQuery: "Namba Yasaka Shrine"
    },
    {
      title: "åˆé¤ & é€šå¤©é–£ æ–°ä¸–ç•Œ",
      placeName: "æ–°ä¸–ç•Œæœ¬é€šå•†åº—è¡—",
      desc: "é€›é€šå¤©é–£å‘¨é‚Šã€åƒé”æ‘©ä¸²ç‚¸æˆ– Usagiya ç”œé»ã€‚",
      mapsQuery: "Shinsekai Tsutenkaku"
    },
    {
      title: "Seventeen in å¤§é˜ªäº¬ç“·å·¨è›‹",
      placeName: "äº¬ç“·å·¨è›‹å¤§é˜ª",
      desc: "16:00 é–‹å§‹å…¥å ´ï¼Œè¨˜å¾—å¸¶ç¥¨ã€æ¯›å·¾ã€æ‡‰æ´ç‰©ã€‚",
      mapsQuery: "Kyocera Dome Osaka"
    },
    {
      title: "æ¼”å”±æœƒå¾Œæ™šé¤",
      placeName: "é›£æ³¢ä¸€å¸¶",
      desc: "å›åˆ°é›£æ³¢å¾Œåƒä¸€è˜­æ‹‰éºµã€ä¸²ç‡’æˆ–ç°¡å–®å®µå¤œã€‚",
      mapsQuery: "Ichiran Namba"
    }
  ];

  const day3 = [
    {
      title: "æ—©åˆé¤",
      placeName: "å¿ƒé½‹æ©‹æˆ–é™„è¿‘å’–å•¡å»³",
      desc: "å¯ä»¥é¸å®¢ç¾å¤šã€HARBS æˆ–é£¯åº—é™„è¿‘æ—©é¤åº—ã€‚",
      mapsQuery: "Komeda Shinsaibashi"
    },
    {
      title: "å‹å°¾å¯ºåŠæ—¥éŠ",
      placeName: "å‹å°¾å¯º",
      desc: "æ­å¾¡å ‚ç­‹ç·šåˆ°ç®•é¢è±é‡ï¼Œè½‰å·´å£«å‰å¾€ã€‚è²·é”æ‘©ç±¤ã€è“‹ç« ã€æ‹ç…§ã€‚",
      mapsQuery: "Katsuo-ji Temple"
    },
    {
      title: "æ¢…ç”° åˆé¤",
      placeName: "æ¢…ç”°è»Šç«™å‘¨é‚Š",
      desc: "å¯ä»¥åƒ new babe ç‚¸è±¬æ’æˆ–è»Šç«™å‘¨é‚Šé¤å»³ã€‚",
      mapsQuery: "Umeda Osaka"
    },
    {
      title: "æ¢…ç”° ç”œé» & é€›è¡—",
      placeName: "LUCUA / HEP FIVE / å¤§ä¸¸æ¢…ç”°",
      desc: "é€›ç™¾è²¨ã€è²·å‰ä¼Šå¡å“‡å‘¨é‚Šã€åƒ HARBS æˆ–åƒå±¤é…¥ã€‚",
      mapsQuery: "LUCUA Osaka"
    },
    {
      title: "æ¢…ç”° æ™šé¤",
      placeName: "æ¢…ç”°ä¸€å¸¶",
      desc: "å¯è€ƒæ…®ç‚¸ç‰›å…ƒæ‘æˆ–å…¶ä»–å±…é…’å±‹ã€ç‡’è‚‰åº—ã€‚",
      mapsQuery: "Umeda dinner Osaka"
    }
  ];

  const day4Data = [
    {
      title: "é€€æˆ¿",
      placeName: "Dormy Inn Premium Nanba ANNEX",
      desc: "æœ€æ™š 08:00 é€€æˆ¿ï¼Œç¢ºèªè¡Œæèˆ‡é‡è¦ç‰©å“ã€‚",
      mapsQuery: "Dormy Inn Premium Nanba Annex"
    },
    {
      title: "å—æµ·ç‰¹æ€¥ â†’ é—œè¥¿ç©ºæ¸¯",
      placeName: "å—æµ·é›»éµ",
      desc: "å¾é›£æ³¢æ­å—æµ·ç‰¹æ€¥å‰å¾€é—œè¥¿æ©Ÿå ´ï¼Œé ç•™è¶³å¤ æ™‚é–“ã€‚",
      mapsQuery: "Nankai Namba Station"
    },
    {
      title: "BR131 é—œè¥¿ â†’ æ¡ƒåœ’",
      placeName: "é—œè¥¿åœ‹éš›æ©Ÿå ´ T1",
      desc: "æ­ä¹˜ BR131 å›æ¡ƒåœ’ï¼ŒçµæŸå››å¤©ä¸‰å¤œæ—…ç¨‹ã€‚",
      mapsQuery: "Kansai International Airport"
    }
  ];

  /* -------- åœ–ç‰‡ imageMap -------- */
  const imageMap = {
    "GK050 æ¡ƒåœ’ T1 â†’ é—œè¥¿ T1": "kansai_airport.jpg",
    "å—æµ·ç‰¹æ€¥ â†’ é›£æ³¢": "nankai_namba_station.jpg",
    "å¯„è¡Œæ": "hotel_lobby.jpg",
    "å¤§é˜ªåŸæ•£ç­–": "osaka_castle.jpg",
    "åˆé¤ï¼šå‰æ¬¡ç‰›èˆŒ é°»è°·åº—": "kittsugi_beef_tongue.jpg",
    "Check-in & ä¸‹åˆèŒ¶": "brunch_generic.jpg",
    "æ™šé¤ï¼šæ¿å‰ç‡’è‚‰ä¸€æ–—ï¼å¤§èµ·æ°´ç”¢": "ittou_yakiniku.jpg",
    "é“é “å € & å¿ƒé½‹æ©‹é€›è¡—": "shinsaibashi_area.jpg",
    "é»‘é–€å¸‚å ´": "kuromon_market.jpg",
    "é›£æ³¢å•†åœˆ & é›£æ³¢å…«é˜ªç¥ç¤¾": "namba_yasaka.jpg",
    "åˆé¤ & é€šå¤©é–£ æ–°ä¸–ç•Œ": "shinsekai_kushikatsu.jpg",
    "Seventeen in å¤§é˜ªäº¬ç“·å·¨è›‹": "kyocera_dome.jpg",
    "æ¼”å”±æœƒå¾Œæ™šé¤": "after_concert_dinner.jpg",
    "æ—©åˆé¤": "harbs_umeda.jpg",
    "å‹å°¾å¯ºåŠæ—¥éŠ": "katsuoji_temple.jpg",
    "æ¢…ç”° åˆé¤": "umeda_hep_five.jpg",
    "æ¢…ç”° ç”œé» & é€›è¡—": "umeda_lucua.jpg",
    "æ¢…ç”° æ™šé¤": "umeda_dinner.jpg",
    "é€€æˆ¿": "hotel_checkout.jpg",
    "å—æµ·ç‰¹æ€¥ â†’ é—œè¥¿ç©ºæ¸¯": "S__21037109_0.jpg",
    "BR131 é—œè¥¿ â†’ æ¡ƒåœ’": "daiki_sushi.jpg"
  };

  /* -------- Modal -------- */
  const modalBackdrop = document.getElementById("modal-backdrop");
  const modalImg = document.getElementById("modal-img");
  const modalTitle = document.getElementById("modal-title");
  const modalSub = document.getElementById("modal-sub");
  const modalDesc = document.getElementById("modal-desc");
  const modalNavBtn = document.getElementById("modal-nav-btn");

  function openModal(ev, dateStr) {
    modalTitle.textContent = ev.title;
    modalSub.textContent = `${dateStr} Â· ${ev.placeName}`;
    modalDesc.textContent = ev.desc;

    const fileName = imageMap[ev.title];
    if (fileName) {
      modalImg.src = `./images/${fileName}`;
    } else {
      modalImg.src =
        "https://dummyimage.com/800x600/020617/ffffff&text=" +
        encodeURIComponent(ev.placeName);
    }

    modalNavBtn.onclick = () => {
      window.open(
        `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
          ev.mapsQuery
        )}`,
        "_blank"
      );
    };

    modalBackdrop.classList.add("show");
  }

  function closeModal() {
    modalBackdrop.classList.remove("show");
  }

  function backdropClick(e) {
    if (e.target === modalBackdrop) closeModal();
  }

  /* -------- Day Bar åˆ‡æ› -------- */
  const dayPills = document.querySelectorAll(".day-pill");
  const dayTimelines = document.querySelectorAll(".day-timeline");

  dayPills.forEach((pill) => {
    pill.addEventListener("click", () => {
      const dayKey = pill.getAttribute("data-day");

      dayPills.forEach((p) => p.classList.remove("active"));
      pill.classList.add("active");

      dayTimelines.forEach((tl) => {
        tl.classList.toggle("active", tl.getAttribute("data-day") === dayKey);
      });

      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });

  /* -------- åŒ¯ç‡ï¼ˆå°éŠ€ï¼‰ -------- */
  let rateJPYtoTWD = 0;

  async function fetchRate() {
    try {
      const res = await fetch("https://rate.bot.com.tw/xrt?Lang=zh-TW");
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const rows = doc.querySelectorAll("table tbody tr");
      rows.forEach((tr) => {
        if (tr.innerText.includes("JPY")) {
          const tds = tr.querySelectorAll("td");
          const sell = parseFloat(tds[5].innerText);
          if (!isNaN(sell)) rateJPYtoTWD = sell;
        }
      });
      console.log("åŒ¯ç‡è®€å–æˆåŠŸï¼š", rateJPYtoTWD);
    } catch (err) {
      console.error("åŒ¯ç‡è®€å–å¤±æ•—ï¼Œæ”¹ç”¨ 0.2 ç•¶é è¨­ï¼š", err);
      rateJPYtoTWD = 0.2;
    }
  }

  /* -------- Supabase åˆå§‹åŒ– -------- */
  const supabaseClient = window.supabase.createClient(
    "https://fmrkkwlmtxzeytjcllag.supabase.co",
    "sb_publishable_8MblOgh8PGTV7Xq3Eg_LNg_0RUtV7cR"
  );

  /* -------- è¨˜å¸³è®€å– / å‘ˆç¾ -------- */
  async function loadExpenses() {
    const { data, error } = await supabaseClient
      .from("budgets")
      .select("*")
      .eq("trip_id", "osaka-2025")
      .order("created_at", { ascending: true });

    if (error) {
      console.error("è®€å–è¨˜å¸³å¤±æ•—", error);
      return;
    }
    renderExpenses(data || []);
  }

  let currentMenu = null;

  function renderExpenses(rows) {
    const listEl = document.getElementById("expense-list");
    const totalEl = document.getElementById("expense-total");
    const settleEl = document.getElementById("settlement");

    listEl.innerHTML = "";

    let totalJPY = 0;
    let byPayer = { ç¾Š: 0, ç†™: 0 };

    rows.forEach((row) => {
      const jpy = Number(row.amount) || 0;
      totalJPY += jpy;
      const twd = rateJPYtoTWD ? Math.round(jpy * rateJPYtoTWD) : 0;

      if (row.payer && byPayer[row.payer] !== undefined) {
        byPayer[row.payer] += twd;
      }

      const item = document.createElement("div");
      item.className = "expense-item";
      item.id = `exp-${row.id}`;
      item.innerHTML = `
        <div class="expense-main">
          <div class="expense-main-title">
            <strong>${row.payer}</strong> æ”¯ä»˜ ${jpy} JPY â‰ˆ ${twd} TWD
          </div>
          <div class="expense-note">${row.note || ""}</div>
        </div>
        <div class="menu-btn" onclick="openMenu('${row.id}', event)">â‹®</div>
      `;
      listEl.appendChild(item);
    });

    const totalTWD = rateJPYtoTWD ? Math.round(totalJPY * rateJPYtoTWD) : 0;
    totalEl.textContent = totalJPY
      ? `ç¸½è¨ˆï¼š${totalJPY} JPYï¼ˆç´„ ${totalTWD} TWDï¼‰`
      : "ç›®å‰å°šæœªè¨˜å¸³ã€‚";

    const each = Math.round(totalTWD / 2);
    const paySheep = byPayer["ç¾Š"];
    const payXi = byPayer["ç†™"];
    const diff = payXi - each;

    let text = "";
    if (totalTWD === 0) {
      text = "å…©å€‹äººé‚„æ²’æœ‰èŠ±åˆ°éŒ¢ã€‚";
    } else if (diff > 0) {
      text = `ç¾Š â†’ ç†™ï¼š${diff} TWD`;
    } else if (diff < 0) {
      text = `ç†™ â†’ ç¾Šï¼š${-diff} TWD`;
    } else {
      text = "AA å®Œå…¨å¹³åˆ†ï¼Œèª°ä¹Ÿä¸ç”¨è£œã€‚";
    }
    settleEl.textContent = text;
  }

  function openMenu(id, event) {
    closeMenu();
    const panel = document.createElement("div");
    panel.className = "menu-panel show";
    panel.innerHTML = `
      <div class="menu-item" onclick="editExpense('${id}')">ç·¨è¼¯</div>
      <div class="menu-item" onclick="deleteExpense('${id}')">åˆªé™¤</div>
    `;
    document.body.appendChild(panel);
    currentMenu = panel;

    const rect = event.target.getBoundingClientRect();
    panel.style.left = rect.right - 120 + "px";
    panel.style.top = rect.bottom + 4 + "px";
  }

  function closeMenu() {
    if (currentMenu) {
      currentMenu.remove();
      currentMenu = null;
    }
  }

  document.body.addEventListener("click", (e) => {
    if (!e.target.classList.contains("menu-btn")) {
      closeMenu();
    }
  });

  async function deleteExpense(id) {
    const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ");
    if (!ok) return;
    const { error } = await supabaseClient
      .from("budgets")
      .delete()
      .eq("id", id);
    if (error) {
      alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      console.error(error);
      return;
    }
    closeMenu();
    loadExpenses();
  }

  async function editExpense(id) {
    closeMenu();
    const newAmount = prompt("è«‹è¼¸å…¥æ–°çš„é‡‘é¡ï¼ˆæ—¥å¹£ï¼‰ï¼š");
    if (newAmount === null) return;
    const amt = Number(newAmount);
    if (isNaN(amt) || amt <= 0) {
      alert("é‡‘é¡å¿…é ˆæ˜¯æ­£æ•¸");
      return;
    }
    const newNote = prompt("è«‹è¼¸å…¥å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰ï¼š") || "";
    const { error } = await supabaseClient
      .from("budgets")
      .update({ amount: amt, note: newNote })
      .eq("id", id);
    if (error) {
      alert("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      console.error(error);
      return;
    }
    loadExpenses();
  }

  /* -------- æ–°å¢è¨˜å¸³ -------- */
  const expenseForm = document.getElementById("expense-form");
  expenseForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const amtInput = document.getElementById("exp-amount");
    const payerSel = document.getElementById("exp-payer");
    const noteInput = document.getElementById("exp-note");

    const amount = Number(amtInput.value);
    if (isNaN(amount) || amount <= 0) {
      alert("é‡‘é¡å¿…é ˆæ˜¯æ­£æ•¸");
      return;
    }
    const payer = payerSel.value;
    const note = noteInput.value.trim();

    const { error } = await supabaseClient.from("budgets").insert([
      {
        trip_id: "osaka-2025",
        amount: amount,
        payer: payer,
        note: note || null
      }
    ]);

    if (error) {
      alert("æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      console.error(error);
      return;
    }

    amtInput.value = "";
    noteInput.value = "";
    loadExpenses();
  });

  /* -------- å¤©æ°£ï¼ˆOpenWeatherï¼‰ -------- */
  const OPENWEATHER_API_KEY = "807111d60af9f37403e02a8705d2ec1e";
  const OSAKA_LAT = 34.6937;
  const OSAKA_LON = 135.5023;

  async function fetchWeather() {
    const brief = document.getElementById("weather-brief");
    try {
      const res = await fetch(
        `https://api.openweathermap.org/data/2.5/weather?lat=${OSAKA_LAT}&lon=${OSAKA_LON}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=zh_tw`
      );
      if (!res.ok) throw new Error("Weather API error");
      const nowJson = await res.json();
      updateWeatherBrief(nowJson, brief);
    } catch (err) {
      console.error("å¤©æ°£è®€å–å¤±æ•—", err);
      if (brief) {
        brief.innerHTML =
          '<span class="weather-brief-dot" style="background:#f97316;"></span>å¤§é˜ªå¤©æ°£æš«æ™‚è®€å–å¤±æ•—';
      }
    }
  }

  function updateWeatherBrief(nowJson, brief) {
    if (!brief || !nowJson || !nowJson.main) return;
    const temp = Math.round(nowJson.main.temp);
    const desc = nowJson.weather?.[0]?.description || "";
    brief.innerHTML =
      '<span class="weather-brief-dot"></span>' +
      `å¤§é˜ªç¾åœ¨ ${temp}Â°C Â· ${desc}`;
  }

  /* -------- Service Worker -------- */
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("./sw.js")
      .then(() => console.log("Service Worker è¨»å†ŠæˆåŠŸ"))
      .catch((err) => console.error("Service Worker è¨»å†Šå¤±æ•—", err));
  }

  /* -------- åˆå§‹åŒ– -------- */
  async function init() {
    await fetchRate();
    await loadExpenses();
    await fetchWeather();
  }

  window.addEventListener("load", init);
</script>
</body>
</html>
